name: Data Quality and Package Checks

on:
  pull_request:
    branches:
      - main
    paths:
      - 'data/*.rda'
      - 'data/*.RData'
      - 'R/**'
      - 'tests/**'
      - 'inst/**'

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history to compare with main
          ref: ${{ github.head_ref }}  # Checkout the PR branch
      
      - name: Fetch main branch
        run: |
          git fetch origin main:main
          echo "Current branch: $(git branch --show-current)"
          echo ""
          echo "Checking if config file exists on current branch:"
          git ls-files inst/config/data_comparison_config.yml || echo "Config file NOT tracked on current branch"
          echo ""
          echo "Checking if config file exists on main branch:"
          git ls-tree main:inst/config/ 2>/dev/null || echo "Config directory doesn't exist on main or is empty"
      
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.0'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libxml2-dev libssl-dev
      
      - name: Install R packages
        run: |
          install.packages(c('dplyr', 'testthat', 'yaml', 'devtools', 'roxygen2', 'remotes'))
        shell: Rscript {0}
      
      # ==========================================
      # CREDENTIAL SCANNING
      # ==========================================
      
      - name: Check for credentials and sensitive files
        id: credential-check
        run: |
          echo "=== Checking for credentials and sensitive files ==="
          FOUND_ISSUES=0
          
          # Files that should NEVER be committed
          FORBIDDEN_FILES=(
            ".Renviron"
            ".env"
            ".httr-oauth"
            ".secrets"
            "credentials.R"
            "config.yml"
          )
          
          # Patterns to search for in code
          FORBIDDEN_PATTERNS=(
            "password\\s*=\\s*['\"][^'\"]{3,}['\"]"
            "api[_-]?key\\s*=\\s*['\"][^'\"]{10,}['\"]"
            "secret\\s*=\\s*['\"][^'\"]{10,}['\"]"
            "token\\s*=\\s*['\"][^'\"]{10,}['\"]"
            "aws_access_key_id"
            "aws_secret_access_key"
          )
          
          echo "Checking for forbidden files..."
          for file in "${FORBIDDEN_FILES[@]}"; do
            if git ls-files | grep -q "^${file}$"; then
              echo "‚ùå ERROR: Found forbidden file: $file"
              FOUND_ISSUES=$((FOUND_ISSUES + 1))
            fi
          done
          
          echo ""
          echo "Checking for credential patterns in code..."
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            matches=$(git grep -i -E "$pattern" -- '*.R' '*.r' '*.Rmd' '*.rmd' 2>/dev/null || true)
            if [ ! -z "$matches" ]; then
              echo "‚ö†Ô∏è  WARNING: Found potential credential pattern:"
              echo "$matches"
              FOUND_ISSUES=$((FOUND_ISSUES + 1))
            fi
          done
          
          echo ""
          if [ $FOUND_ISSUES -eq 0 ]; then
            echo "‚úÖ No credentials or sensitive files found"
          else
            echo "‚ùå Found $FOUND_ISSUES potential issues"
          fi
          
          echo "credential_issues=$FOUND_ISSUES" >> $GITHUB_OUTPUT
      
      # ==========================================
      # R PACKAGE STRUCTURE CHECK
      # ==========================================
      
      - name: Check R package structure
        id: structure-check
        run: |
          echo "=== Checking R package structure ==="
          STRUCTURE_ISSUES=0
          
          # Required files for R package
          REQUIRED_FILES=(
            "DESCRIPTION"
            "NAMESPACE"
          )
          
          # Required directories
          REQUIRED_DIRS=(
            "R"
            "man"
          )
          
          # Recommended directories
          RECOMMENDED_DIRS=(
            "data"
            "tests"
            "inst"
          )
          
          # Files that shouldn't be in root
          MISPLACED_FILES=(
            "*.rda"
            "*.RData"
            "*.rds"
          )
          
          echo "Checking required files..."
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå ERROR: Missing required file: $file"
              STRUCTURE_ISSUES=$((STRUCTURE_ISSUES + 1))
            else
              echo "‚úì Found: $file"
            fi
          done
          
          echo ""
          echo "Checking required directories..."
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "‚ùå ERROR: Missing required directory: $dir/"
              STRUCTURE_ISSUES=$((STRUCTURE_ISSUES + 1))
            else
              echo "‚úì Found: $dir/"
            fi
          done
          
          echo ""
          echo "Checking recommended directories..."
          for dir in "${RECOMMENDED_DIRS[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "‚ö†Ô∏è  Warning: Missing recommended directory: $dir/"
            else
              echo "‚úì Found: $dir/"
            fi
          done
          
          echo ""
          echo "Checking for misplaced data files..."
          for pattern in "${MISPLACED_FILES[@]}"; do
            files=$(find . -maxdepth 1 -name "$pattern" -type f 2>/dev/null || true)
            if [ ! -z "$files" ]; then
              echo "‚ö†Ô∏è  Warning: Data files in root directory (should be in data/):"
              echo "$files"
            fi
          done
          
          echo ""
          echo "Checking DESCRIPTION file format..."
          if [ -f "DESCRIPTION" ]; then
            if ! grep -q "^Package:" DESCRIPTION; then
              echo "‚ùå ERROR: DESCRIPTION missing 'Package:' field"
              STRUCTURE_ISSUES=$((STRUCTURE_ISSUES + 1))
            fi
            if ! grep -q "^Version:" DESCRIPTION; then
              echo "‚ùå ERROR: DESCRIPTION missing 'Version:' field"
              STRUCTURE_ISSUES=$((STRUCTURE_ISSUES + 1))
            fi
            if ! grep -q "^Title:" DESCRIPTION; then
              echo "‚ö†Ô∏è  Warning: DESCRIPTION missing 'Title:' field"
            fi
          fi
          
          echo ""
          echo "Checking for proper .Rbuildignore..."
          if [ ! -f ".Rbuildignore" ]; then
            echo "‚ö†Ô∏è  Warning: No .Rbuildignore file found"
          else
            echo "‚úì Found: .Rbuildignore"
          fi
          
          echo ""
          if [ $STRUCTURE_ISSUES -eq 0 ]; then
            echo "‚úÖ Package structure looks good"
          else
            echo "‚ùå Found $STRUCTURE_ISSUES structure issues"
          fi
          
          echo "structure_issues=$STRUCTURE_ISSUES" >> $GITHUB_OUTPUT
      
      # ==========================================
      # TESTTHAT TESTS
      # ==========================================
      
      - name: Run testthat tests
        id: testthat
        continue-on-error: true
        run: |
          echo "=== Running testthat tests ==="
          
          if [ ! -d "tests/testthat" ]; then
            echo "‚ö†Ô∏è  No tests/testthat directory found"
            echo "To add tests, create tests/testthat/ and add test files"
            echo "test_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Count test files
          TEST_FILES=$(find tests/testthat -name "test*.R" | wc -l)
          echo "Found $TEST_FILES test file(s)"
          
          if [ $TEST_FILES -eq 0 ]; then
            echo "‚ö†Ô∏è  No test files found in tests/testthat/"
            echo "test_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Run tests
          Rscript -e "
          library(testthat)
          
          # Try to load package with devtools if available
          tryCatch({
            if (requireNamespace('devtools', quietly = TRUE)) {
              devtools::load_all('.', quiet = TRUE)
              cat('‚úì Package loaded with devtools\n')
            } else {
              # Try loading without devtools
              cat('‚ö†Ô∏è  devtools not available, loading package namespace directly\n')
              # Source all R files
              r_files <- list.files('R', pattern = '\\\\.R
      
      # ==========================================
      # DATA COMPARISON
      # ==========================================
      
      - name: Debug git and file info
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
          echo "Current branch: $(git branch --show-current)"
          echo "Git log (last 2 commits on current branch):"
          git log --oneline -2
          echo ""
          echo "Git log (last 2 commits on main):"
          git log --oneline -2 main
          echo ""
          echo "Testing git show command:"
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Checking: $file"
            echo "  On current branch: $(git log -1 --format="%h" -- $file)"
            echo "  On main: $(git log -1 --format="%h" main -- $file)"
            echo "  Attempting git show main:$file"
            git show main:$file > /tmp/test_output 2>&1 && echo "  ‚úì Success" || echo "  ‚úó Failed"
            if [ -f /tmp/test_output ]; then
              echo "  File size: $(wc -c < /tmp/test_output) bytes"
              rm /tmp/test_output
            fi
          done
      
      - name: Check for config file
        run: |
          echo "=== Checking for config file ==="
          echo "Current directory: $(pwd)"
          echo ""
          echo "Full directory tree:"
          find . -name "data_comparison_config.yml" -o -name "*.yml" -path "*/config/*" 2>/dev/null || echo "No yml files found in config directories"
          echo ""
          echo "Checking standard location:"
          if [ -f "inst/config/data_comparison_config.yml" ]; then
            echo "‚úì Configuration file found at inst/config/data_comparison_config.yml"
            echo "File size: $(wc -c < inst/config/data_comparison_config.yml) bytes"
            echo ""
            echo "Config file contents:"
            cat inst/config/data_comparison_config.yml
          else
            echo "‚ùå Configuration file NOT found at inst/config/data_comparison_config.yml"
            echo ""
            echo "Checking if file is tracked by git:"
            git ls-files | grep -i config || echo "No config files tracked by git"
            echo ""
            echo "Repository structure:"
            ls -la
            if [ -d "inst" ]; then
              echo ""
              echo "inst/ directory contents:"
              ls -la inst/
              if [ -d "inst/config" ]; then
                echo ""
                echo "inst/config/ directory contents:"
                ls -la inst/config/
              fi
            fi
          fi
      
      - name: Compare data files
        if: steps.changed-files.outputs.any_changed == 'true'
        id: comparison
        continue-on-error: true
        run: |
          Rscript inst/scripts/compare_data_files.R "${{ steps.changed-files.outputs.all_changed_files }}"
          echo "comparison_exit_code=$?" >> $GITHUB_OUTPUT
        
      - name: Upload comparison report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: data-comparison-report
          path: comparison_report.txt
          retention-days: 30
      
      - name: Check for approval override
        if: steps.comparison.outputs.comparison_exit_code != '0'
        id: check-approval
        uses: actions/github-script@v7
        with:
          script: |
            // Check if PR has "data-changes-approved" label
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const approved = labels.includes('data-changes-approved');
            
            console.log('PR labels:', labels);
            console.log('Has approval:', approved);
            
            core.setOutput('approved', approved);
            return approved;
      - name: Comment PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Get all check statuses
            const credentialIssues = parseInt('${{ steps.credential-check.outputs.credential_issues }}') || 0;
            const structureIssues = parseInt('${{ steps.structure-check.outputs.structure_issues }}') || 0;
            const testStatus = '${{ steps.testthat.outputs.test_status }}' || 'unknown';
            const comparisonExitCode = '${{ steps.comparison.outputs.comparison_exit_code }}';
            const dataApproved = '${{ steps.check-approval.outputs.approved }}' === 'true';
            
            // Read comparison report
            let comparisonReport = 'No comparison report generated.';
            if (fs.existsSync('comparison_report.txt')) {
              comparisonReport = fs.readFileSync('comparison_report.txt', 'utf8');
            }
            
            // Build status summary
            let statusSummary = '## üîç Quality Check Summary\n\n';
            
            // Credential check
            if (credentialIssues > 0) {
              statusSummary += '‚ùå **Credential Scan:** Found ' + credentialIssues + ' potential issue(s)\n';
            } else {
              statusSummary += '‚úÖ **Credential Scan:** No credentials detected\n';
            }
            
            // Structure check
            if (structureIssues > 0) {
              statusSummary += '‚ùå **Package Structure:** Found ' + structureIssues + ' issue(s)\n';
            } else {
              statusSummary += '‚úÖ **Package Structure:** Valid R package structure\n';
            }
            
            // Test results
            if (testStatus === 'passed') {
              statusSummary += '‚úÖ **Tests:** All tests passed\n';
            } else if (testStatus === 'failed') {
              statusSummary += '‚ùå **Tests:** Some tests failed\n';
            } else if (testStatus === 'skipped') {
              statusSummary += '‚ö†Ô∏è **Tests:** No tests found (skipped)\n';
            } else {
              statusSummary += '‚ùì **Tests:** Status unknown\n';
            }
            
            // Data comparison
            if (comparisonExitCode === '0') {
              statusSummary += '‚úÖ **Data Comparison:** No unauthorized modifications\n';
            } else if (dataApproved) {
              statusSummary += '‚ö†Ô∏è **Data Comparison:** Changes manually approved\n';
            } else {
              statusSummary += '‚ùå **Data Comparison:** Unauthorized modifications (requires approval)\n';
            }
            
            statusSummary += '\n---\n\n';
            
            // Detailed sections
            let detailedReport = '';
            
            // Data comparison details
            if (comparisonExitCode !== '0') {
              let dataMessage = '';
              if (dataApproved) {
                dataMessage = '‚ö†Ô∏è **Data modifications detected but manually approved.** The PR has the `data-changes-approved` label.';
              } else {
                dataMessage = `‚ùå **Data modifications detected and not approved.**
            
            **To approve these changes:**
            1. Review the comparison report below carefully
            2. Verify the modifications are intentional and correct
            3. Add the \`data-changes-approved\` label to this PR
            4. The check will automatically pass once the label is added
            
            **Note:** Only repository maintainers should approve data modifications.`;
              }
              
              detailedReport += `### üìä Data File Comparison\n\n${dataMessage}\n\n${comparisonReport}\n\n---\n\n`;
            }
            
            // Credential issues details
            if (credentialIssues > 0) {
              detailedReport += `### üîê Credential Scan Issues
            
            **Action Required:** Review the "Check for credentials" step in the workflow logs to see what was detected.
            
            **Common issues:**
            - \`.Renviron\` file committed (should be in .gitignore)
            - Hardcoded API keys or passwords in code
            - OAuth tokens or secrets
            
            **How to fix:**
            1. Remove sensitive files from the commit
            2. Use environment variables instead: \`Sys.getenv("API_KEY")\`
            3. Add sensitive files to \`.gitignore\`
            4. If credentials were already pushed, rotate them immediately
            
            ---
            
            `;
            }
            
            // Structure issues details
            if (structureIssues > 0) {
              detailedReport += `### üì¶ Package Structure Issues
            
            **Action Required:** Review the "Check R package structure" step in the workflow logs.
            
            **Common issues:**
            - Missing DESCRIPTION or NAMESPACE file
            - Missing required directories (R/, man/)
            - Data files in wrong location
            
            **How to fix:**
            1. Ensure standard R package structure
            2. Run \`devtools::check()\` locally
            3. See: https://r-pkgs.org/structure.html
            
            ---
            
            `;
            }
            
            // Test failure details  
            if (testStatus === 'failed') {
              detailedReport += `### üß™ Test Failures
            
            **Action Required:** Review the "Run testthat tests" step in the workflow logs.
            
            **How to fix:**
            1. Run tests locally: \`devtools::test()\`
            2. Fix failing tests
            3. Push updated code
            
            ---
            
            `;
            }
            
            // Info footer
            const infoFooter = `
            <details>
            <summary>‚ÑπÔ∏è About these checks</summary>
            
            **Credential Scan:** Prevents accidental commit of API keys, passwords, and other sensitive information.
            
            **Package Structure:** Ensures the repository follows R package standards.
            
            **Tests:** Runs automated tests to verify code functionality.
            
            **Data Comparison:** Ensures existing data values are not modified unless explicitly allowed.
            
            For more information, see the repository documentation.
            </details>`;
            
            const fullComment = statusSummary + detailedReport + infoFooter;
            
            // Find and update or create comment
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Quality Check Summary')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: fullComment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: fullComment
              });
            }
      
      - name: Final status check
        if: always()
        run: |
          echo "=== Final Status Check ==="
          
          CREDENTIAL_ISSUES="${{ steps.credential-check.outputs.credential_issues }}"
          STRUCTURE_ISSUES="${{ steps.structure-check.outputs.structure_issues }}"
          TEST_STATUS="${{ steps.testthat.outputs.test_status }}"
          COMPARISON_EXIT="${{ steps.comparison.outputs.comparison_exit_code }}"
          DATA_APPROVED="${{ steps.check-approval.outputs.approved }}"
          
          if [ -z "$CREDENTIAL_ISSUES" ]; then CREDENTIAL_ISSUES=0; fi
          if [ -z "$STRUCTURE_ISSUES" ]; then STRUCTURE_ISSUES=0; fi
          if [ -z "$TEST_STATUS" ]; then TEST_STATUS=unknown; fi
          if [ -z "$COMPARISON_EXIT" ]; then COMPARISON_EXIT=0; fi
          if [ -z "$DATA_APPROVED" ]; then DATA_APPROVED=false; fi
          
          echo "Credential issues: $CREDENTIAL_ISSUES"
          echo "Structure issues: $STRUCTURE_ISSUES"
          echo "Test status: $TEST_STATUS"
          echo "Comparison exit code: $COMPARISON_EXIT"
          echo "Data approved: $DATA_APPROVED"
          echo ""
          
          FAILURES=0
          
          if [ "$CREDENTIAL_ISSUES" != "0" ]; then
            echo "‚ùå Credential scan found issues"
            FAILURES=$((FAILURES + 1))
          fi
          
          if [ "$STRUCTURE_ISSUES" != "0" ]; then
            echo "‚ùå Package structure has issues"
            FAILURES=$((FAILURES + 1))
          fi
          
          if [ "$TEST_STATUS" = "failed" ]; then
            echo "‚ùå Tests failed"
            FAILURES=$((FAILURES + 1))
          fi
          
          if [ "$COMPARISON_EXIT" != "0" ] && [ "$DATA_APPROVED" != "true" ]; then
            echo "‚ùå Data comparison failed and not approved"
            FAILURES=$((FAILURES + 1))
          fi
          
          echo ""
          if [ "$FAILURES" -eq 0 ]; then
            echo "‚úÖ All checks passed!"
            exit 0
          else
            echo "‚ùå $FAILURES check(s) failed"
            echo "Review the PR comment for details."
            exit 1
          fi