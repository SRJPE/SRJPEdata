---
title: "RST Data checks - DBvs EDI"
author: "Badhia Yunes Katz"
output: html_document
---

```{r include=FALSE}
library(DBI)
library(tidyverse)
library(EDIutils)
library(EML)
library(readr)
library(janitor)
```

The purpose of this markdown is to compare the data that we have in jpe database and EDI. Data is being queried directly from the database and from EDI, this script can be used to check most up to date uploads.

Database tables are be viewed first, then data is compared by stream

```{r include=FALSE}
# con <- DBI::dbConnect(drv = RPostgres::Postgres(),
#                       host = "jpe-db.postgres.database.azure.com",
#                       dbname = "jpedb-prod",
#                       user = Sys.getenv("jpe_db_user_id"),
#                       password = Sys.getenv("jpe_db_password"),
#                       port = 5432)

con <- dbConnect(
  RPostgres::Postgres(),
  dbname = "jpedb-staging",
  host = "jpe-db.postgres.database.azure.com",
  port = 5432,                
  user = Sys.getenv("jpe_db_user_id"),
  password = Sys.getenv("jpe_db_password")
)

DBI::dbListTables(con)
# tables to look at:
# catch, trap, release and recapture_fish (check if it is release or release_fish) 
```

# catch table

```{r echo=FALSE}
catch <- DBI::dbReadTable(con, "catch")
head(catch)
colnames(catch)
```

streams in catch table

```{r echo=FALSE}
unique(catch$trap_location_id)
```

date range

```{r echo=FALSE}
range(catch$date, na.rm = TRUE)
```

# trap table

```{r include=FALSE}
trap <- DBI::dbReadTable(con, "trap_visit")
```

```{r echo=FALSE}
head(trap)

colnames(trap)
```

date range

  - `trap_visit_start`
  
```{r echo=FALSE}
range(trap$trap_visit_time_start, na.rm = TRUE)
```

  - `trap_visit_end`
  
```{r echo=FALSE}
range(trap$trap_visit_time_end, na.rm = TRUE)
```

# release table

```{r include=FALSE}
release <- DBI::dbReadTable(con, "release")
```

```{r echo=FALSE}
head(release)
colnames(release)
```

date range
```{r echo=FALSE}
range(release$date_released, na.rm = TRUE)
```

# recaptured_fish table

```{r include=FALSE}
recaptured_fish <- DBI::dbReadTable(con, "recaptured_fish")
```

```{r echo=FALSE}
head(recaptured_fish)

colnames(recaptured_fish)
```

date range
```{r echo=FALSE}
range(recaptured_fish$date, na.rm = TRUE)
```

## Exploration per stream {.tabset}


### Battle/Clear Creek

#### catch

**- Findings catch:**
    - same date range, just off by a moth
    - forklength max of EDI is higher
    - lifestage is challenging to compare since there are more categories on edi
  
```{r include=FALSE}
# pulling trap_location table to tie to a steam
trap_location <- DBI::dbReadTable(con, "trap_location")
trap_id <- trap_location |> 
  rename(trap_location_id = id) |>
  select(trap_location_id, stream) 

catch_with_stream <- catch |>
  left_join(trap_id)

catch_battle_db <- catch_with_stream |> 
  filter(stream %in% c("clear creek", "battle creek")) 
```

  - DB date range
  
```{r echo=FALSE}
range(catch_battle_db$date)
```

  - EDI date range

```{r echo=FALSE}
battle_catch_url <- "https://pasta.lternet.edu/package/data/eml/edi/1509/3/58540ac4ed34ce05f3309510f4be91e5"
# Read the catch table
catch_battle_edi <- read_csv(battle_catch_url, show_col_types = FALSE)

range(catch_battle_edi$sample_date)
```

Checking stations of EDI to be battle and clear

```{r echo=FALSE}
# streams EDI
unique(catch_battle_edi$station_code)
```

*fork_length*

EDI 

* `r round(sum(is.na(catch_battle_edi$fork_length))/nrow(catch_battle_edi), 3)*100` % of values in the `fork_length` column are NA.

```{r echo=FALSE}
summary(catch_battle_edi$fork_length, na.rm = TRUE)
```

DB

* `r round(sum(is.na(catch_battle_db$fork_length))/nrow(catch_battle_db), 3)*100` % of values in the `fork_length` column are NA.

```{r echo=FALSE}
summary(catch_battle_db$fork_length, na.rm = TRUE)
```

```{r include=FALSE}
catch_battle_edi_edited <- catch_battle_edi |> 
  rename(date = sample_date,
         life_stage_id = life_stage) |> 
  mutate(source = "EDI") |> 
  filter(date > ymd("1998-10-24"))

catch_battle_db_edited <- catch_battle_db |> 
  mutate(source = "DB") 

# Combine both datasets
combined_catch_battle <- bind_rows(catch_battle_edi_edited, catch_battle_db_edited)
```

exploration plots 

```{r echo=FALSE, warning=FALSE}
ggplot(combined_catch_battle, aes(x = date, y = fork_length, color = source)) +
  geom_point(alpha = 0.6) +
  theme_minimal() +
  labs(x = "date", y = "fork length", color = "Source")
```

* `r round(sum(is.na(catch_battle_db$lifestage_id))/nrow(catch_battle_db), 3)*100` % of values in the `lifestage_id` column from the database are NA.

```{r echo=FALSE, warning=FALSE}
catch_battle_db |> 
   ggplot(aes(x = as.factor(lifestage_id), y = fork_length, fill = as.factor(lifestage_id))) +
  geom_boxplot(outlier.shape = 16, outlier.size = 1, alpha = 0.7) +
  coord_flip() +
  theme_minimal() +
  labs(x = "lifestage id", y = "fork length", title = "DB data - lifestage vs forklength")
```

* `r round(sum(is.na(catch_battle_edi$lifestage_id))/nrow(catch_battle_edi), 3)*100` % of values in the `lifestage_id` column from the EDI data are NA.

```{r echo=FALSE, warning=FALSE}
catch_battle_edi |> 
   ggplot(aes(x = as.factor(life_stage), y = fork_length, fill = as.factor(life_stage))) +
  geom_boxplot(outlier.shape = 16, outlier.size = 1, alpha = 0.7) +
  coord_flip() +
  theme_minimal() +
  labs(x = "lifestage id", y = "fork length", title = "EDI data - lifestage vs forklength")
```

*count*

* `r round(sum(is.na(catch_battle_edi$count))/nrow(catch_battle_edi), 3)*100` % of values in the `count` column in edi data are NA.

* `r round(sum(is.na(catch_battle_db$count))/nrow(catch_battle_db), 3)*100` % of values in the `count` column in database data are NA.

```{r echo=FALSE, warning=FALSE}
ggplot(combined_catch_battle, aes(x = date, y = count, color = source)) +
  geom_jitter(alpha = 0.6, width = 0.3, height = 0) +
  theme_minimal() +
  labs(x = "date", y = "count", color = "Source")
```

Random pick of data entry to compare between db and EDI

  - test 1

```{r echo=FALSE}
# random pick to compare data 
catch_battle_db |> 
  filter(catch_raw_id == "{511A1464-8C0E-4CBC-83619A1F91634CBC}") |> 
  glimpse()

catch_battle_edi |> 
  filter(catch_row_id == "{511A1464-8C0E-4CBC-83619A1F91634CBC}") |> 
  glimpse()
```

  - test 2

```{r echo=FALSE}
# random pick to compare data 
catch_battle_db |> 
  filter(catch_raw_id == "{29329E00-E17B-42A0-8049C108CC8CB18D}") |> 
  glimpse()

catch_battle_edi |> 
  filter(catch_row_id == "{29329E00-E17B-42A0-8049C108CC8CB18D}") |> 
  glimpse()
```

  - test 3

```{r echo=FALSE}
# random pick to compare data 
catch_battle_db |> 
  filter(catch_raw_id == "{2566D65B-9F77-43C7-9F77A072A899FD7D}") |> 
  glimpse()

catch_battle_edi |> 
  filter(catch_row_id == "{2566D65B-9F77-43C7-9F77A072A899FD7D}") |> 
  glimpse()
```

  - test 4

```{r echo=FALSE}
# random pick to compare data 
catch_battle_db |> 
  filter(catch_raw_id == "{B21666EA-D802-4C28-A3B1372EDD715D97}") |> 
  glimpse()

catch_battle_edi |> 
  filter(catch_row_id == "{B21666EA-D802-4C28-A3B1372EDD715D97}") |> 
  glimpse()
```

#### trap

  - Findings:
    - overall date rage is similar, just off by a month 
    - for random test 4, there are 4 data entries on database that seem dupicate, but with different id. Is this something we should check?. they have the same `trap_visit_time_start`/`trap_start_date` 
    

  - Database date range

```{r echo=FALSE}
trap_with_stream <- trap |>
  left_join(trap_id)
trap_battle_db <- trap_with_stream |> 
  filter(stream %in% c("clear creek", "battle creek")) 

range(trap_battle_db$trap_visit_time_start, na.rm = TRUE)
```

 - EDI date range

```{r echo=FALSE}
battle_trap_url <- "https://pasta.lternet.edu/package/data/eml/edi/1509/3/eed3b61b7eb6030dafc9e4765f07a106"
# Read the trap table
trap_battle_edi <- read_csv(battle_trap_url, show_col_types = FALSE)

range(trap_battle_edi$sample_date)
```

*water_velocity*

Database:

* `r round(sum(is.na(trap_battle_edi$water_velocity))/nrow(trap_battle_edi), 3)*100` % of values in the `water_velocity` column are NA.
```{r echo=FALSE}
summary(trap_battle_db$water_velocity)
```

EDI:
* `r round(sum(is.na(trap_battle_edi$water_velocity))/nrow(trap_battle_edi), 3)*100` % of values in the `water_velocity` column are NA.
```{r echo=FALSE}
summary(trap_battle_edi$velocity)
```

```{r echo=FALSE}
trap_battle_db |> 
  ggplot(aes(trap_visit_time_start, water_velocity)) +
  geom_line()

trap_battle_edi |> 
  ggplot(aes(sample_date, velocity)) +
  geom_line()
```

```{r echo=FALSE}
trap_battle_db_edited <- trap_battle_db |> 
  mutate(source = "DB",
         velocity = water_velocity,
         trap_start_date = as.Date(trap_visit_time_start))

trap_battle_edi_edited <- trap_battle_edi |> 
  mutate(source = "EDI")

combined_trap_battle <- bind_rows(trap_battle_db_edited, trap_battle_edi_edited)

combined_trap_battle |> 
  ggplot(aes(trap_start_date, velocity, color = source)) +
  geom_jitter(alpha = 0.6, width = 0.3, height = 1) +
  theme_minimal() 
```


Random pick of data entry to compare between db and EDI

  - test 1 (hard to compare because many NAs)

```{r echo=FALSE}
# random pick to compare data 
trap_battle_db |> 
  filter(id == "2093106") |> 
  mutate(source = "DB") |> 
  glimpse()

trap_battle_edi |> 
  filter(sample_date == "2024-08-09") |> 
  mutate(source = "EDI") |> 
  glimpse()
```

  - test 2 

```{r echo=FALSE}
# random pick to compare data 
trap_battle_db |> 
  filter(id == "2013985") |> 
  mutate(source = "DB") |> 
  glimpse()

trap_battle_edi |> 
  filter(trap_start_date == "2013-11-09" & velocity == "3.67") |> 
  mutate(source = "EDI") |> 
  glimpse()
```

  - test 3 

```{r echo=FALSE}
# random pick to compare data 
trap_battle_db |> 
  filter(id == "2007291") |> 
  mutate(source = "DB") |> 
  glimpse()

trap_battle_edi |> 
  filter(trap_start_date == "2003-10-24" & velocity == "0.15") |> 
  mutate(source = "EDI") |> 
  glimpse()
```

  - test 4

```{r echo=FALSE}
# random pick to compare data 
trap_battle_edi |> 
  filter(trap_start_date == "2012-01-20" & velocity == "3.75") |> 
  mutate(source = "DB") |> 
  glimpse()

trap_battle_db |> 
  mutate(date = as.Date(trap_visit_time_start)) |> 
  filter(water_velocity == "3.75" & date == "2012-01-20") |> 
  mutate(source = "EDI") |> 
  glimpse()
```

#### release

**Findings:**

  - date range is the same
  - fork length values seem the same as well 
  - random checks are consistenet

DB glimpse

```{r echo=FALSE}
release_with_stream <- release |> # join to get stream names
  left_join(trap_id)

release_battle_db <- release_with_stream |> 
  filter(stream %in% c("clear creek", "battle creek")) |>  glimpse()
```

  - Database date range (`date_released`)

```{r echo=FALSE}
range(release_battle_db$date_released, na.rm = TRUE)
```

EDI glimpse

```{r echo=FALSE}
battle_release_url <- "https://pasta.lternet.edu/package/data/eml/edi/1509/3/414dd61cd26985641875fb194328f8a6"

release_battle_edi <- read_csv(battle_release_url, show_col_types = FALSE)
glimpse(release_battle_edi)
```

- EDI date range (`date_released`)

```{r echo=FALSE}
range(release_battle_edi$date_released)
```

*median_fork_length_released*

EDI:

* `r round(sum(is.na(release_battle_edi$median_fork_length_released))/nrow(release_battle_edi), 3)*100` % of values in the `median_fork_length_released` column are NA.
```{r echo=FALSE}
summary(release_battle_edi$median_fork_length_released)
```

DB:

* `r round(sum(is.na(release_battle_db$median_fork_length_released))/nrow(release_battle_db), 3)*100` % of values in the `median_fork_length_released` column are NA.
```{r echo=FALSE}
summary(release_battle_db$median_fork_length_released)
```

```{r echo=FALSE, warning=FALSE}
ggplot() +
  geom_jitter(data = release_battle_db,
              aes(x = as.Date(date_released), y = median_fork_length_released),
              color = "blue", alpha = 0.4, width = 10, height = 0.5, shape = 16, size = 2) +
  geom_jitter(data = release_battle_edi,
              aes(x = as.Date(date_released), y = median_fork_length_released),
              color = "red", alpha = 0.4, width = 10, height = 0.5, shape = 17, size = 2) +
  theme_minimal() +
  labs(x = "Date Released",
       y = "Median Fork Length Released")
           
```

Random pick of data entry to compare between db and EDI

  - test 1

```{r echo=FALSE}
# random pick to compare data 
release_battle_db |> 
  filter(release_id == "CLR637") |> 
  mutate(source = "DB") |> 
  glimpse()

release_battle_edi |> 
  filter(release_id == "CLR637") |> 
  mutate(source = "EDI") |> 
  glimpse()
```

  - test 2

```{r echo=FALSE}
# random pick to compare data 
release_battle_db |> 
  filter(release_id == "BAT187") |> 
  mutate(source = "DB") |> 
  glimpse()

release_battle_edi |> 
  filter(release_id == "BAT187") |> 
  mutate(source = "EDI") |> 
  glimpse()
```

  - test 4

```{r echo=FALSE}
# random pick to compare data 
release_battle_db |> 
  filter(release_id == "CLR497") |> 
  mutate(source = "DB") |> 
  glimpse()

release_battle_edi |> 
  filter(release_id == "CLR497") |> 
  mutate(source = "EDI") |> 
  glimpse()
```

#### recapture (recapture_fish)

**Findings: **

  - date ranges are the same
  - overall forklength and recapture values look the same
  - across the random tests there were 4 data entries on db with the same `release_id`, wondering if we should look into this

Database glimpse:

```{r echo=FALSE}
recapture_with_stream <- recaptured_fish |> # join to get stream names
  left_join(trap_id)

recapture_battle_db <- recapture_with_stream |> 
  filter(stream %in% c("clear creek", "battle creek")) |> 
  glimpse()
```

  - Database date range (`recaptured_fish`)

```{r echo=FALSE}
range(recapture_battle_db$date)
```

EDI glimpse:

```{r echo=FALSE}
battle_recapture_url <- "https://pasta.lternet.edu/package/data/eml/edi/1509/3/460853b8a4a0a2308c2bfb4d3dc2793c"

recapture_battle_edi <- read_csv(battle_recapture_url, show_col_types = FALSE)

glimpse(recapture_battle_edi)
```


- EDI date range (`date_recaptured`)

```{r echo=FALSE}
range(recapture_battle_edi$date_recaptured)
```

*date vs count/number_recapture*

* `r round(sum(is.na(recapture_battle_db$count))/nrow(recapture_battle_db), 3)*100` % of values in the `count` column from the database are NA.

* `r round(sum(is.na(recapture_battle_edi$number_recaptured))/nrow(recapture_battle_edi), 3)*100` % of values in the `number_recaptured` column from EDI are NA.
```{r echo=FALSE, warning=FALSE}
ggplot() +
  geom_jitter(data = recapture_battle_db,
              aes(x = date, y = count),
              color = "blue", alpha = 0.4, width = 10, height = 0.5, shape = 16, size = 2) +
  geom_jitter(data = recapture_battle_edi,
              aes(x = date_recaptured, y = number_recaptured),
              color = "red", alpha = 0.4, width = 10, height = 0.5, shape = 17, size = 2) +
  theme_minimal() +
  labs(x = "Date Recaptured",
       y = "count/number_recaptured")
```

*date vs fork_length*

* `r round(sum(is.na(recapture_battle_db$fork_length))/nrow(recapture_battle_db), 3)*100` % of values in the `fork_length` column from the database are NA.

* `r round(sum(is.na(recapture_battle_edi$median_fork_length_recaptured))/nrow(recapture_battle_edi), 3)*100` % of values in the `median_fork_length_recaptured` column from EDI are NA.

```{r echo=FALSE, warning=FALSE}
ggplot() +
  geom_jitter(data = recapture_battle_db,
              aes(x = date, y = fork_length),
              color = "blue", alpha = 0.4, width = 10, height = 0.5, shape = 16, size = 2) +
  geom_jitter(data = recapture_battle_edi,
              aes(x = date_recaptured, y = median_fork_length_recaptured),
              color = "red", alpha = 0.4, width = 10, height = 0.5, shape = 17, size = 2) +
  theme_minimal() +
  labs(x = "Date Recaptured",
       y = "count/fork_length")
```

Random pick of data entry to compare between db and EDI

  - test 1

```{r echo=FALSE}
# random pick to compare data 
recapture_battle_db |> 
  filter(release_id == "CLR210" & date == "2004-04-13") |> 
  mutate(source = "DB") |> 
  glimpse()

recapture_battle_edi |> 
  filter(release_id == "CLR210" & date_recaptured == "2004-04-13") |> 
  mutate(source = "EDI") |> 
  glimpse()
```

  - test 2

```{r echo=FALSE}
# random pick to compare data 
recapture_battle_edi |> 
  filter(release_id == "CLR386" & date_recaptured == "2008-03-02") |> 
  mutate(source = "EDI") |> 
  glimpse()

recapture_battle_db |> 
  filter(release_id == "CLR386" & date == "2008-03-02") |> 
  mutate(source = "DB") |> 
  glimpse()
```

  - test 3

```{r echo=FALSE}
# random pick to compare data 
recapture_battle_edi |> 
  filter(release_id == "CLR677" & date_recaptured == "2017-01-31") |> 
  mutate(source = "EDI") |> 
  glimpse()

recapture_battle_db |> 
  filter(release_id == "CLR677" & date == "2017-01-31") |> 
  mutate(source = "DB") |> 
  glimpse()
```

  - test 4

```{r echo=FALSE}
# random pick to compare data 
recapture_battle_edi |> 
  filter(release_id == "BAT371" & date_recaptured == "2024-04-03") |> 
  mutate(source = "EDI") |> 
  glimpse()

recapture_battle_db |> 
  filter(release_id == "BAT371" & date == "2024-04-03") |> 
  mutate(source = "DB") |> 
  glimpse()
```

### Butte

#### catch

**- Findings catch:**
    - date range is different, will filter EDI to start 1999 for this data comparison purpose 
    - It seems like the database only has a few data entires from 1999, 2017 and 2020. Then it jumps to 2022 onwards
    - lifestage on EDI data are repetitive (e.g. Parr vs parr, Smolt va smolt)
    - test 2: catch_raw_id == "15924" was not found in Data (called catchRawID on EDI)
    - test 4: date of 2022-02-22 does not match any data entries on database (there seems to be a gap between 1999 and 2022, check if this is expected)

  - DB date range
  
```{r echo=FALSE}
catch_butte_db <- catch_with_stream |> 
  filter(stream == "butte creek") 

range(catch_butte_db$date)
```
  
  - EDI date range (`visitTime`)

```{r echo=FALSE}
catch_butte_edi <- read_csv("data-raw/edi-zips/butte_catch.csv") |> glimpse()
range(catch_butte_edi$visitTime)
```

*forkLength*

EDI 

* `r round(sum(is.na(catch_butte_edi$forkLength))/nrow(catch_butte_edi), 3)*100` % of values in the `forkLength` column are NA.

```{r echo=FALSE}
summary(catch_butte_edi$forkLength, na.rm = TRUE)
```

DB

* `r round(sum(is.na(catch_butte_db$fork_length))/nrow(catch_butte_db), 3)*100` % of values in the `fork_length` column are NA.

```{r echo=FALSE}
summary(catch_butte_db$fork_length, na.rm = TRUE)
```


```{r include=FALSE}
catch_butte_edi_edited <- catch_butte_edi |>
  clean_names() |>
  mutate(date = as.Date(visit_time)) |> 
  mutate(source = "EDI") |>
  filter(date > ymd("1999-06-04")) 
 
catch_butte_db_edited <- catch_butte_db |>
  mutate(source = "DB")
```

exploration plots 

```{r echo=FALSE, warning=FALSE}
combined_catch_butte <- catch_butte_db_edited |> 
  select(date, fork_length, source) |> 
  bind_rows(catch_butte_edi_edited |> select(date, fork_length, source)) 

ggplot(data = combined_catch_butte, aes(x = date, y = fork_length, color = source)) +
  geom_point() +
  facet_wrap(~source)
```

* `r round(sum(is.na(catch_butte_db$lifestage_id))/nrow(catch_butte_db), 3)*100` % of values in the `lifestage_id` column from the database are NA.

```{r echo=FALSE, warning=FALSE}
catch_butte_db |> 
   ggplot(aes(x = as.factor(lifestage_id), y = fork_length, fill = as.factor(lifestage_id))) +
  geom_boxplot(outlier.shape = 16, outlier.size = 1, alpha = 0.7) +
  coord_flip() +
  theme_minimal() +
  labs(x = "lifestage id", y = "fork length", title = "DB data - lifestage vs forklength")
```

* `r round(sum(is.na(catch_butte_edi$lifeStage))/nrow(catch_butte_edi), 3)*100` % of values in the `lifeStage` column from the EDI data are NA.

```{r echo=FALSE, warning=FALSE}
catch_butte_edi |> 
   ggplot(aes(x = as.factor(lifeStage), y = forkLength, fill = as.factor(lifeStage))) +
  geom_boxplot(outlier.shape = 16, outlier.size = 1, alpha = 0.7) +
  coord_flip() +
  theme_minimal() +
  labs(x = "lifestage id", y = "fork length", title = "EDI data - lifestage vs forklength")
```

*count*

* `r round(sum(is.na(catch_butte_edi$n))/nrow(catch_butte_edi), 3)*100` % of values in the `n` column in edi data are NA.

```{r echo=FALSE}
summary(catch_butte_edi$n)
```

* `r round(sum(is.na(catch_butte_db$count))/nrow(catch_butte_db), 3)*100` % of values in the `count` column in database data are NA.

```{r echo=FALSE}
summary(catch_butte_db$count)
```


```{r echo=FALSE, warning=FALSE}
ggplot(catch_butte_db_edited, aes(x = date, y = count, color = source)) +
  geom_jitter(alpha = 0.6, width = 0.3, height = 0) +
  theme_minimal() +
  labs(x = "date", y = "count", color = "Source")

ggplot() +
  geom_jitter(data = catch_butte_db_edited,
              aes(x = date, y = count),
              color = "blue", alpha = 0.4, width = 10, height = 0.5, shape = 16, size = 2) +
  geom_jitter(data = catch_butte_edi_edited,
              aes(x = date, y = n),
              color = "red", alpha = 0.4, width = 10, height = 0.5, shape = 17, size = 2) +
  theme_minimal() +
  labs(x = "Date",
       y = "count/n")
```

Random pick of data entry to compare between db and EDI

  - test 1

```{r echo=FALSE}
# random pick to compare data 
catch_butte_db |> 
  mutate(source = "DB") |> 
  filter(id == "45936875") |> 
  glimpse()

catch_butte_edi |> 
  mutate(source = "EDI") |> 
  filter(catchRawID == "55171") |> 
  glimpse()
```

  - test 2

```{r echo=FALSE}
# random pick to compare data
catch_butte_edi |> 
  mutate(source = "EDI") |> 
  filter(catchRawID == "15924") |> 
  glimpse()

catch_butte_db |> 
  mutate(source = "DB") |> 
  filter(catch_raw_id  == "15924") |> 
  glimpse()
```

  - test 2

```{r echo=FALSE}
# random pick to compare data
catch_butte_db |> 
  mutate(source = "DB") |> 
  filter(catch_raw_id  == "51525") |> 
  glimpse()

catch_butte_edi |> 
  mutate(source = "EDI") |> 
  filter(catchRawID == "51525") |> 
  glimpse()
```
 
 - test 3

```{r echo=FALSE}
# random pick to compare data
catch_butte_db |> 
  mutate(source = "DB") |> 
  filter(catch_raw_id  == "60956") |> 
  glimpse()

catch_butte_edi |> 
  mutate(source = "EDI") |> 
  filter(catchRawID == "60956") |> 
  glimpse()
```

 - test 4

```{r echo=FALSE}
# random pick to compare data
catch_butte_edi |> 
  mutate(source = "EDI") |> 
  filter(catchRawID == "33534") |> 
  glimpse()

catch_butte_db |> 
  mutate(source = "DB") |> 
  filter(date == "2022-02-22") |> 
  glimpse()
```

#### trap

**- Findings catch:**
   - time ranges are different, database has 2020 data only (wondering if this is an error?)

  - Database glimpse
```{r echo=FALSE}
trap_with_stream <- trap |>
  left_join(trap_id)
  
trap_butte_db <- trap_with_stream |>  #lots of NA's on trap_visit_time_start, so using trap_visit_time_end instead
  filter(stream %in% c("butte creek")) |> 
  glimpse()
```

  - Database date range (`trap_visit_time_end`)
  
```{r echo=FALSE}
range(trap_butte_db$trap_visit_time_end, na.rm = TRUE)
```

  - Database glimpse
```{r echo=FALSE}
# Read the trap table
trap_butte_edi <- read_csv("data-raw/edi-zips/butte_trap.csv") |> glimpse()
```

  - EDI date range (current_year_butte_trap.csv `visitTime`)
```{r echo=FALSE}
range(trap_butte_edi$visitTime)
```


#### release

**- Findings catch:**
   - time ranges are exactly the same

  - Database date range 

```{r echo=FALSE}
release_butte_db <- release_with_stream |> 
  filter(stream %in% c("butte creek")) 
  
range(release_butte_db$date_released)
```

- EDI date range (`releaseTime`)

```{r include=FALSE}
release_butte_edi <- read_csv("data-raw/edi-zips/butte_release.csv") 

range(release_butte_edi$releaseTime, na.rm = TRUE)
```

*number_released and nReleased*

* `r round(sum(is.na(release_butte_db$number_released))/nrow(release_butte_db), 3)*100` % of values in the `number_released` column in the database dataset are NA.

* `r round(sum(is.na(release_butte_edi$nReleased))/nrow(release_butte_edi), 3)*100` % of values in the `nReleased` column in the database dataset are NA.


```{r echo=FALSE}
release_butte_edi_clean<- release_butte_edi |> 
  mutate(date = as.Date(releaseTime)) 
release_butte_db_clean<- release_butte_db |> 
  mutate(date = as.Date(date_released)) 

ggplot() +
  geom_jitter(data = release_butte_db_clean,
              aes(x = date, y = number_released),
              color = "blue", alpha = 0.4, width = 10, height = 0.5, shape = 16, size = 2) +
  geom_jitter(data = release_butte_edi_clean,
              aes(x = date, y = nReleased),
              color = "red", alpha = 0.4, width = 10, height = 0.5, shape = 17, size = 2) +
  theme_minimal() +
  labs(x = "Date Recaptured",
       y = "count/fork_length")
```

#### recapture

**- Findings catch:**
   - database eaarliest year is 2023, edi is 2021
   

  - Database date range (`recaptured_fish`)

```{r echo=FALSE}
recapture_butte_db <- recapture_with_stream |> 
  filter(stream %in% c("butte creek")) |> glimpse()

range(recapture_butte_db$date)
```

- EDI date range (`visitTime`) 

```{r include=FALSE}
recapture_butte_edi <- read_csv("data-raw/edi-zips/butte_recapture.csv") |> glimpse()

range(recapture_butte_edi$visitTime, na.rm = TRUE)
```
#TODO - continue here

### Feather River

#### catch

  - Database date range
  
```{r echo=FALSE}
catch_feather_db <- catch_with_stream |> 
  filter(stream == "feather river") |> glimpse()


catch_with_stream |> 
  filter(stream == "feather river") |> 
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))

```
  
 - EDI date range

```{r echo=FALSE}
# feather_catch_url <- "https://pasta.lternet.edu/package/data/eml/edi/1239/23/c142ed6d5527bb824d113c7d64b54215"
# # Read the catch table
# feather_catch_data <- read_csv(feather_catch_url, show_col_types = FALSE)
catch_feather_edi <- read_csv("data-raw/edi-zips/feather_catch.csv") |> glimpse()

range(catch_feather_edi$visitTime)
```

#### trap

  - Database date range (`trap_visit_time_end`)

```{r echo=FALSE}
trap_with_stream |>  
  filter(stream %in% c("feather river")) |> 
  summarize(min_date = min(trap_visit_time_end, na.rm = TRUE),
            max_date = max(trap_visit_time_end, na.rm = TRUE))
```

  - EDI date range (current_year_feather_catch.csv `visitTime`)

```{r echo=FALSE}
feather_trap_url <- "https://pasta.lternet.edu/package/data/eml/edi/1239/23/e13781ce693c968eb8954907c64b9666"

# Read the catch table
feather_trap_data <- read_csv(feather_trap_url, show_col_types = FALSE)

range(feather_trap_data$visitTime)
```

#### release

  - Database date range 

```{r echo=FALSE}
release_with_stream |> 
  filter(stream %in% c("feather river")) |> 
  summarize(min_date = min(date_released), max_date = max(date_released))
```

- EDI date range (`releaseTime`)

```{r include=FALSE}
feather_release_url <- "https://pasta.lternet.edu/package/data/eml/edi/1239/23/faaac9cea6a7050037d1ef92c1154ead"

feather_release_data <- read_csv(feather_release_url, show_col_types = FALSE)
```


```{r echo=FALSE}
feather_release_data |> 
  mutate(releaseTime = as.Date(releaseTime)) |>
  summarize(min_date = min(releaseTime), max_date = max(releaseTime))
```

#### recapture

  - Database date range (`recaptured_fish`)

```{r echo=FALSE}
recapture_with_stream |> 
  filter(stream %in% c("feather river")) |> 
  summarize(min_date = min(date ), max_date = max(date ))
```

- EDI date range (`current_year_feather_recapture.csv`)

```{r echo=FALSE}
feather_recapture_url <- "https://pasta.lternet.edu/package/data/eml/edi/1239/23/5135215c5b52b74193ccc83a93812ea9"

feather_recapture_data <- read_csv(feather_recapture_url, show_col_types = FALSE)

range(feather_recapture_data$visitTime)
```
  
### Yuba

#### catch

  - Database date range
  
```{r echo=FALSE}
catch_yuba_db <- catch_with_stream |> 
  filter(stream == "yuba river") |> glimpse()

catch_with_stream |> 
  filter(stream == "yuba river") |> 
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))

```
  
 - EDI date range

```{r echo=FALSE}
# yuba_catch_url <- "https://pasta.lternet.edu/package/data/eml/edi/1529/24/5dc3db7932a98e185f9c4ae8b0490c1d"
# # Read the catch table
# yuba_catch_data <- read_csv(yuba_catch_url, show_col_types = FALSE)
# 
# range(yuba_catch_data$visitTime)

catch_yuba_edi <- read_csv("data-raw/edi-zips/yuba_catch.csv") |> glimpse()

range(catch_yuba_edi$visitTime)
```

*fork_length*

EDI 

```{r echo=FALSE}

summary(catch_yuba_edi$forkLength, na.rm = TRUE)
```

DB

```{r echo=FALSE}
summary(catch_yuba_db$fork_length, na.rm = TRUE)
```


```{r echo=FALSE}
catch_yuba_edi |> 
  ggplot(aes(visitTime, forkLength)) +
  geom_point()

catch_yuba_db |> 
  ggplot(aes(date, fork_length)) +
  geom_point()

```


*edi - count* and *database - n*

```{r echo=FALSE}
catch_yuba_edi |> 
  ggplot(aes(visitTime, n)) +
  geom_point() +
  labs(title = "EDI Yuba catch")

catch_yuba_db |> 
  ggplot(aes(date, count)) +
  geom_point()+
  labs(title = "Database Yuba catch")
```

Random pick of data entry to compare between db and EDI

```{r echo=FALSE}
# random pick to compare data 

catch_yuba_db |> 
  # filter(date == "2024-01-25") |> 
  filter(catch_raw_id == "16336.0") |> 
  glimpse()

catch_yuba_edi |> 
  filter(catchRawID == "16336") |> 
  glimpse()

```

test 2

```{r echo=FALSE}
catch_yuba_db |> 
  # filter(date == "2024-01-25") |> 
  filter(catch_raw_id == "21795.0") |> 
  glimpse()

catch_yuba_edi |> 
  filter(catchRawID == "21795") |> 
  glimpse()
```
test 3

```{r echo=FALSE}
catch_yuba_db |> 
  # filter(date == "2024-01-25") |> 
  filter(date == "2024-12-27" & catch_raw_id == "31918.0") |> 

  glimpse()

catch_yuba_edi |> 
  filter(catchRawID == "31918") |> 
  glimpse()
```

test 4

```{r echo=FALSE}
catch_yuba_db |> 
  # filter(date == "2024-01-25") |> 
  filter(date == "2023-04-24" & catch_raw_id == "8830.0") |> 

  glimpse()

catch_yuba_edi |> 
  filter(catchRawID == "8830") |> 
  glimpse()
```

#### trap

Note: database has a temporal coverage of 2015 - 2025, and EDI has a data as early as 1999

  - Database date range (`trap_visit_time_end`)

```{r echo=FALSE}
trap_yuba_db <- trap_with_stream |>  
  filter(stream %in% c("yuba river")) |> glimpse()

range(trap_yuba_db$trap_visit_time_start, na.rm = TRUE)

  # summarize(min_date = min(trap_visit_time_end, na.rm = TRUE),
  #           max_date = max(trap_visit_time_end, na.rm = TRUE))
```

  - EDI date range (current_year_feather_catch.csv `visitTime`)

```{r echo=FALSE}
# yuba_trap_url <- "https://pasta.lternet.edu/package/data/eml/edi/1529/24/09ccf28b4e8eaa3239026109b6e408e2"
# 
# # Read the trap table
# yubar_trap_data <- read_csv(yuba_trap_url, show_col_types = FALSE)

trap_yuba_edi <- read_csv("data-raw/edi-zips/yuba_trap.csv") |> glimpse()

range(trap_yuba_edi$visitTime)
```
*water temp*

```{r include=FALSE}
trap_yuba_db |> 
  ggplot(aes(trap_visit_time_start, water_temp)) +
  geom_point()

trap_yuba_edi |> 
  ggplot(aes(visitTime, waterTemp)) +
  geom_point()

# edi filtering just 2015 - 2025
trap_yuba_edi |> 
  filter(visitTime > "2015-01-01") |> 
  ggplot(aes(visitTime, waterTemp)) +
  geom_point()
```

```{r echo=FALSE}
trap_yuba_edi <- trap_yuba_edi |> 
  filter(visitTime > "2015-01-01") |> 
  mutate(source = "EDI") |> 
  rename(time = visitTime, temp = waterTemp)

trap_yuba_db <- trap_yuba_db |> 
  mutate(source = "DB") |> 
  rename(time = trap_visit_time_start, temp = water_temp)

# Combine both datasets
combined_trap_yuba <- bind_rows(trap_yuba_edi, trap_yuba_db)

ggplot(combined_trap_yuba, aes(x = time, y = temp, color = source)) +
  geom_point(alpha = 0.6) +
  theme_minimal() +
  labs(x = "visit time", y = "water temp", color = "Source",
       title = "water temp vs visitTime")
```

Random pick of data entry to compare between db and EDI

```{r echo=FALSE}
trap_yuba_db |> 
  # filter(date == "2024-01-25") |> 
  filter(id == "2044844") |> 
  glimpse()

trap_yuba_edi |> 
  filter(trapVisitID == "11") |> 
  glimpse()
```
test 2

```{r echo=FALSE}
trap_yuba_db |> 
  # filter(date == "2024-01-25") |> 
  filter(id == "2045597") |> 
  glimpse()

trap_yuba_edi |> 
  filter(trapVisitID == "960") |> 
  glimpse()
```

test 3

```{r echo=FALSE}
trap_yuba_db |> 
  # filter(date == "2024-01-25") |> 
  filter(id == "2045982") |> 
  glimpse()

trap_yuba_edi |> 
  filter(trapVisitID == "643") |> 
  glimpse()
```
test 4

```{r echo=FALSE}
trap_yuba_db |> 
  filter(id == "2044846") |> 
  glimpse()

trap_yuba_edi |> 
  filter(trapVisitID == "16") |> 
  glimpse()
```

#### release

  - Database date range - No Yuba release on DB

```{r echo=FALSE}
release_with_stream |> 
  filter(stream %in% c("yuba river")) |> glimpse() 
```

- EDI date range (current_year_yuba_release.csv `releaseTime`)

```{r include=FALSE}
yuba_release_url <- "https://pasta.lternet.edu/package/data/eml/edi/1529/24/356e130a4b70fbb91b768c87508432df"

yuba_release_data <- read_csv(yuba_release_url, show_col_types = FALSE)
```


```{r echo=FALSE}
yuba_release_data |> 
  mutate(releaseTime = as.Date(releaseTime)) |>
  summarize(min_date = min(releaseTime), max_date = max(releaseTime))
```

#### recapture

  - No Recapture on Database 

```{r echo=FALSE}
recapture_with_stream |> 
  filter(stream %in% c("yuba river")) |>  glimpse()
```
  - No recapture on EDI
  
### Sacramento/Knights landing 

#### catch

  - Database date range

```{r}
catch_with_stream |> 
  filter(trap_location_id %in% c(51, 52, 53, 54)) |>  # trap id for Sacramento/Knights landing
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))
```
 - EDI date range (current_year_knights_landing_catch.csv)

```{r echo=FALSE}
knights_catch_url <- "https://pasta.lternet.edu/package/data/eml/edi/1501/9/98cc4ae4d068f0f1bd17560b65d83b44"
# Read the catch table
knights_catch_data <- read_csv(knights_catch_url, show_col_types = FALSE)

range(knights_catch_data$visitTime)
```

#### trap

  - Database date range (`trap_visit_time_end`)

```{r echo=FALSE}
trap_with_stream |>  
  filter(trap_location_id %in% c(51, 52, 53, 54)) |>  # trap id for Sacramento/Knights landing 
  summarize(min_date = min(trap_visit_time_end, na.rm = TRUE),
            max_date = max(trap_visit_time_end, na.rm = TRUE))
```

  - EDI date range (current_year_feather_catch.csv `visitTime`)

```{r echo=FALSE}
knigts_trap_url <- "https://pasta.lternet.edu/package/data/eml/edi/1501/9/104b1e3f236b495564ee77efda3392af"

# Read the trap table
knighs_trap_data <- read_csv(knigts_trap_url, show_col_types = FALSE)

range(knighs_trap_data$visitTime)
```

#### release

  - Database date range 

```{r echo=FALSE}
release_with_stream |> 
  filter(trap_location_id %in% c(51, 52, 53, 54)) |> 
  summarize(min_date = min(date_released, na.rm = TRUE),
            max_date = max(date_released, na.rm = TRUE))
```

- EDI date range (current_year_yuba_release.csv `releaseTime`)

```{r}
knights_release_url <- "https://pasta.lternet.edu/package/data/eml/edi/1501/9/bed15fe599f379266fe4ca74ebba0b6a"

knights_release_data <- read_csv(knights_release_url, show_col_types = FALSE)

knights_release_data |> 
  mutate(releaseTime = as.Date(releaseTime)) |>
  summarize(min_date = min(releaseTime), max_date = max(releaseTime))
```

#### recapture

  - Database date range

```{r echo=FALSE}
recapture_with_stream |> 
  filter(trap_location_id %in% c(51, 52, 53, 54)) |>
  summarize(min_date = min(date), max_date = max(date))
```
  - No recapture on EDI
  
  
### Sacramento/Tisdale

#### catch

  - Database date range

```{r echo=FALSE}
catch_with_stream |> 
  filter(trap_location_id %in% c(55,56,57)) |>  # trap id for Sacramento/Knights landing
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))
```
  - EDI: note that EDI download was done through a zip file. It is showing off on EDI

Checked manually and interval is 2010 - 2024

```{r echo=FALSE}
sacramento_tisdale <- "edi.1499.5"
```

#### trap

  - Database date range

```{r echo=FALSE}
trap_with_stream |>  
  filter(trap_location_id %in% c(55, 56, 57)) |>  # trap id for Sacramento/Knights landing 
  summarize(min_date = min(trap_visit_time_end, na.rm = TRUE),
            max_date = max(trap_visit_time_end, na.rm = TRUE))
```

  - EDI: 2010 - 2024
  
#### release

  - Database date range 

```{r echo=FALSE}
release_with_stream |> 
  filter(trap_location_id %in% c(55, 56, 57)) |> 
  summarize(min_date = min(date_released, na.rm = TRUE),
            max_date = max(date_released, na.rm = TRUE))
```

  - EDI: 2012 - 2024
  
#### recapture

  - Database date range

```{r echo=FALSE}
recapture_with_stream |> 
  filter(trap_location_id %in% c(55, 56, 57)) |>
  summarize(min_date = min(date), max_date = max(date))
```

  - EDI: 2010 - 2024 
  