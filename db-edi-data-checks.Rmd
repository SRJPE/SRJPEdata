---
title: "RST Data checks - DBvs EDI"
author: "Badhia Yunes Katz"
output: html_document
---

```{r include=FALSE}
library(DBI)
library(tidyverse)
library(EDIutils)
library(EML)
library(readr)
```

The purpose of this markdown is to compare the data that we have in jpe database and EDI. Data is being queried directly from the database and from EDI, this script can be used to check most up to date uploads.

Database tables are be viewed first, then data is compared by stream

```{r}
# con <- DBI::dbConnect(drv = RPostgres::Postgres(),
#                       host = "jpe-db.postgres.database.azure.com",
#                       dbname = "jpedb-prod",
#                       user = Sys.getenv("jpe_db_user_id"),
#                       password = Sys.getenv("jpe_db_password"),
#                       port = 5432)

con <- dbConnect(
  RPostgres::Postgres(),
  dbname = "jpedb-staging",
  host = "jpe-db.postgres.database.azure.com",
  port = 5432,                
  user = "AdminJPE",
  password = "Food4Chinook"
)

DBI::dbListTables(con)
# tables to look at:
# catch, trap, release and recapture_fish (check if it is release or release_fish) 
```

# catch table

```{r include=FALSE}
catch <- DBI::dbReadTable(con, "catch")
```

```{r echo=FALSE}
head(catch)

colnames(catch)
```

streams in catch table

```{r}
unique(catch$trap_location_id)
```

date range

```{r echo=FALSE}
range(catch$date, na.rm = TRUE)
```

# trap table

```{r include=FALSE}
trap <- DBI::dbReadTable(con, "trap_visit")
```

```{r echo=FALSE}
head(trap)

colnames(trap)
```

date range

  - `trap_visit_start`
  
```{r echo=FALSE}
range(trap$trap_visit_time_start, na.rm = TRUE)
```

  - `trap_visit_end`
  
```{r echo=FALSE}
range(trap$trap_visit_time_end, na.rm = TRUE)
```

# release table

```{r include=FALSE}
release <- DBI::dbReadTable(con, "release")
```

```{r echo=FALSE}
head(release)

colnames(release)
```

date range
```{r echo=FALSE}
range(release$date_released, na.rm = TRUE)
```

# recaptured_fish table

```{r include=FALSE}
recaptured_fish <- DBI::dbReadTable(con, "recaptured_fish")
```

```{r echo=FALSE}
head(recaptured_fish)

colnames(recaptured_fish)
```

date range
```{r echo=FALSE}
range(recaptured_fish$date, na.rm = TRUE)
```

## Exploration per stream {.tabset}


### Battle/Clear Creek

#### catch

  - Database date range
  
```{r echo=FALSE}
# pulling trap_location table to tie to a steam
trap_location <- DBI::dbReadTable(con, "trap_location")
trap_id <- trap_location |> 
  rename(trap_location_id = id) |>
  select(trap_location_id, stream) 

catch_with_stream <- catch |>
  left_join(trap_id)
  
catch_with_stream |> 
  filter(stream %in% c("clear creek", "battle creek")) |> 
  summarize(min_date = min(date), max_date = max(date))
  
```
  
  - EDI date range

```{r echo=FALSE}
battle_catch_url <- "https://pasta.lternet.edu/package/data/eml/edi/1509/3/58540ac4ed34ce05f3309510f4be91e5"
# Read the catch table
battle_catch_data <- read_csv(battle_catch_url, show_col_types = FALSE)

range(battle_catch_data$sample_date)
```


#### trap

  - Database date range

```{r echo=FALSE}
trap_with_stream <- trap |>
  left_join(trap_id)
  
trap_with_stream |> 
  filter(stream %in% c("clear creek", "battle creek")) |> 
  summarize(min_date = min(trap_visit_time_start), max_date = max(trap_visit_time_start))
```

 - EDI date range

```{r echo=FALSE}
battle_trap_url <- "https://pasta.lternet.edu/package/data/eml/edi/1509/3/eed3b61b7eb6030dafc9e4765f07a106"
# Read the trap table
battle_trap_data <- read_csv(battle_trap_url, show_col_types = FALSE)

range(battle_trap_data$sample_date)

```

#### release

  - Database date range (`date_released`)

```{r echo=FALSE}
release_with_stream <- release |> # join to get stream names
  left_join(trap_id)

release_with_stream |> 
  filter(stream %in% c("clear creek", "battle creek")) |> 
  summarize(min_date = min(date_released ), max_date = max(date_released ))
```

- EDI date range (`date_released`)

```{r include=FALSE}
battle_release_url <- "https://pasta.lternet.edu/package/data/eml/edi/1509/3/414dd61cd26985641875fb194328f8a6"

battle_release_data <- read_csv(battle_release_url, show_col_types = FALSE)
```


```{r echo=FALSE}
range(battle_release_data$date_released)
```

#### recapture

  - Database date range (`recaptured_fish`)

```{r echo=FALSE}
recapture_with_stream <- recaptured_fish |> # join to get stream names
  left_join(trap_id)

recapture_with_stream |> 
  filter(stream %in% c("clear creek", "battle creek")) |> 
  summarize(min_date = min(date ), max_date = max(date ))
```

- EDI date range (`date_recaptured`)

```{r echo=FALSE}
battle_recapture_url <- "https://pasta.lternet.edu/package/data/eml/edi/1509/3/460853b8a4a0a2308c2bfb4d3dc2793c"

battle_recapture_data <- read_csv(battle_recapture_url, show_col_types = FALSE)

range(battle_recapture_data$date_recaptured)
```


### Butte

#### catch

  - Database date range
  
```{r echo=FALSE}
catch_with_stream |> 
  filter(stream == "butte creek") |> 
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))

```
  
  - EDI date range (current_year_butte_catch.csv `visitTime`)

```{r echo=FALSE}
butte_catch_url <- "https://pasta.lternet.edu/package/data/eml/edi/1497/18/5d9e3251b1453262701d3464339934a5"

# Read the catch table
butte_catch_data <- read_csv(butte_catch_url, show_col_types = FALSE)

range(butte_catch_data$visitTime)
```

#### trap

  - Database date range (`trap_visit_time_end`)

```{r echo=FALSE}
trap_with_stream <- trap |>
  left_join(trap_id)
  
trap_with_stream |>  #lots of NA's on trap_visit_time_start, so using trap_visit_time_end instead
  filter(stream %in% c("butte creek")) |> 
  summarize(min_date = min(trap_visit_time_end, na.rm = TRUE),
            max_date = max(trap_visit_time_end, na.rm = TRUE))
```

  - EDI date range (current_year_butte_trap.csv `visitTime`)

```{r echo=FALSE}
butte_trap_url <- "https://pasta.lternet.edu/package/data/eml/edi/1497/18/64d3ac3b7695992c8a2cf3cfca90a4ce"

# Read the catch table
butte_trap_data <- read_csv(butte_trap_url, show_col_types = FALSE)

range(butte_trap_data$visitTime)
```

#### release

  - Database date range 

```{r echo=FALSE}
release_with_stream |> 
  filter(stream %in% c("butte creek")) |> 
  summarize(min_date = min(date_released), max_date = max(date_released))
```

- EDI date range (`releaseTime`)

```{r include=FALSE}
butte_release_url <- "https://pasta.lternet.edu/package/data/eml/edi/1497/18/a6be3d2d878b4c4bd2815b60fda8a0db"

butte_release_data <- read_csv(butte_release_url, show_col_types = FALSE)
```


```{r echo=FALSE}
butte_release_data |> 
mutate(releaseTime = as.Date(releaseTime)) |>
  summarize(min_date = min(releaseTime), max_date = max(releaseTime))
```

#### recapture

  - Database date range (`recaptured_fish`)

```{r echo=FALSE}
recapture_with_stream |> 
  filter(stream %in% c("butte creek")) |> 
  summarize(min_date = min(date ), max_date = max(date ))
```
  - No recapture on EDI
  
### Feather River

#### catch

  - Database date range
  
```{r echo=FALSE}
catch_with_stream |> 
  filter(stream == "feather river") |> 
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))

```
  
 - EDI date range

```{r echo=FALSE}
feather_catch_url <- "https://pasta.lternet.edu/package/data/eml/edi/1239/23/c142ed6d5527bb824d113c7d64b54215"
# Read the catch table
feather_catch_data <- read_csv(feather_catch_url, show_col_types = FALSE)

range(feather_catch_data$visitTime)
```

#### trap

  - Database date range (`trap_visit_time_end`)

```{r echo=FALSE}
trap_with_stream |>  
  filter(stream %in% c("feather river")) |> 
  summarize(min_date = min(trap_visit_time_end, na.rm = TRUE),
            max_date = max(trap_visit_time_end, na.rm = TRUE))
```

  - EDI date range (current_year_feather_catch.csv `visitTime`)

```{r echo=FALSE}
feather_trap_url <- "https://pasta.lternet.edu/package/data/eml/edi/1239/23/e13781ce693c968eb8954907c64b9666"

# Read the catch table
feather_trap_data <- read_csv(feather_trap_url, show_col_types = FALSE)

range(feather_trap_data$visitTime)
```

#### release

  - Database date range 

```{r echo=FALSE}
release_with_stream |> 
  filter(stream %in% c("feather river")) |> 
  summarize(min_date = min(date_released), max_date = max(date_released))
```

- EDI date range (`releaseTime`)

```{r include=FALSE}
feather_release_url <- "https://pasta.lternet.edu/package/data/eml/edi/1239/23/faaac9cea6a7050037d1ef92c1154ead"

feather_release_data <- read_csv(feather_release_url, show_col_types = FALSE)
```


```{r echo=FALSE}
feather_release_data |> 
  mutate(releaseTime = as.Date(releaseTime)) |>
  summarize(min_date = min(releaseTime), max_date = max(releaseTime))
```
#### recapture

  - Database date range (`recaptured_fish`)

```{r echo=FALSE}
recapture_with_stream |> 
  filter(stream %in% c("feather river")) |> 
  summarize(min_date = min(date ), max_date = max(date ))
```

- EDI date range (`current_year_feather_recapture.csv`)

```{r echo=FALSE}
feather_recapture_url <- "https://pasta.lternet.edu/package/data/eml/edi/1239/23/5135215c5b52b74193ccc83a93812ea9"

feather_recapture_data <- read_csv(feather_recapture_url, show_col_types = FALSE)

range(feather_recapture_data$visitTime)
```
  
### Yuba

#### catch

  - Database date range
  
```{r echo=FALSE}
catch_with_stream |> 
  filter(stream == "yuba river") |> 
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))

```
  
 - EDI date range

```{r echo=FALSE}
yuba_catch_url <- "https://pasta.lternet.edu/package/data/eml/edi/1529/24/5dc3db7932a98e185f9c4ae8b0490c1d"
# Read the catch table
yuba_catch_data <- read_csv(yuba_catch_url, show_col_types = FALSE)

range(yuba_catch_data$visitTime)
```

#### trap

  - Database date range (`trap_visit_time_end`)

```{r echo=FALSE}
trap_with_stream |>  
  filter(stream %in% c("yuba river")) |> 
  summarize(min_date = min(trap_visit_time_end, na.rm = TRUE),
            max_date = max(trap_visit_time_end, na.rm = TRUE))
```

  - EDI date range (current_year_feather_catch.csv `visitTime`)

```{r echo=FALSE}
yuba_trap_url <- "https://pasta.lternet.edu/package/data/eml/edi/1529/24/09ccf28b4e8eaa3239026109b6e408e2"

# Read the trap table
yubar_trap_data <- read_csv(yuba_trap_url, show_col_types = FALSE)

range(yubar_trap_data$visitTime)
```

#### release

  - Database date range - No Yuba release on DB

```{r echo=FALSE}
release_with_stream |> 
  filter(stream %in% c("yuba river")) |> glimpse() 
```

- EDI date range (current_year_yuba_release.csv `releaseTime`)

```{r include=FALSE}
yuba_release_url <- "https://pasta.lternet.edu/package/data/eml/edi/1529/24/356e130a4b70fbb91b768c87508432df"

yuba_release_data <- read_csv(yuba_release_url, show_col_types = FALSE)
```


```{r echo=FALSE}
yuba_release_data |> 
  mutate(releaseTime = as.Date(releaseTime)) |>
  summarize(min_date = min(releaseTime), max_date = max(releaseTime))
```

#### recapture

  - No Recapture on Database 

```{r echo=FALSE}
recapture_with_stream |> 
  filter(stream %in% c("yuba river")) |>  glimpse()
```
  - No recapture on EDI
  
### Sacramento/Knights landing 

#### catch

  - Database date range

```{r}
catch_with_stream |> 
  filter(trap_location_id %in% c(51, 52, 53, 54)) |>  # trap id for Sacramento/Knights landing
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))
```
 - EDI date range (current_year_knights_landing_catch.csv)

```{r echo=FALSE}
knights_catch_url <- "https://pasta.lternet.edu/package/data/eml/edi/1501/9/98cc4ae4d068f0f1bd17560b65d83b44"
# Read the catch table
knights_catch_data <- read_csv(knights_catch_url, show_col_types = FALSE)

range(knights_catch_data$visitTime)
```

#### trap

  - Database date range (`trap_visit_time_end`)

```{r echo=FALSE}
trap_with_stream |>  
  filter(trap_location_id %in% c(51, 52, 53, 54)) |>  # trap id for Sacramento/Knights landing 
  summarize(min_date = min(trap_visit_time_end, na.rm = TRUE),
            max_date = max(trap_visit_time_end, na.rm = TRUE))
```

  - EDI date range (current_year_feather_catch.csv `visitTime`)

```{r echo=FALSE}
knigts_trap_url <- "https://pasta.lternet.edu/package/data/eml/edi/1501/9/104b1e3f236b495564ee77efda3392af"

# Read the trap table
knighs_trap_data <- read_csv(knigts_trap_url, show_col_types = FALSE)

range(knighs_trap_data$visitTime)
```

#### release

  - Database date range 

```{r echo=FALSE}
release_with_stream |> 
  filter(trap_location_id %in% c(51, 52, 53, 54)) |> 
  summarize(min_date = min(date_released, na.rm = TRUE),
            max_date = max(date_released, na.rm = TRUE))
```

- EDI date range (current_year_yuba_release.csv `releaseTime`)

```{r}
knights_release_url <- "https://pasta.lternet.edu/package/data/eml/edi/1501/9/bed15fe599f379266fe4ca74ebba0b6a"

knights_release_data <- read_csv(knights_release_url, show_col_types = FALSE)

knights_release_data |> 
  mutate(releaseTime = as.Date(releaseTime)) |>
  summarize(min_date = min(releaseTime), max_date = max(releaseTime))
```

#### recapture

  - Database date range

```{r echo=FALSE}
recapture_with_stream |> 
  filter(trap_location_id %in% c(51, 52, 53, 54)) |>
  summarize(min_date = min(date), max_date = max(date))
```
  - No recapture on EDI
  
  
### Sacramento/Tisdale

#### catch

  - Database date range

```{r echo=FALSE}
catch_with_stream |> 
  filter(trap_location_id %in% c(55,56,57)) |>  # trap id for Sacramento/Knights landing
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))
```
  - EDI: note that EDI download was done through a zip file. It is showing off on EDI

Checked manually and interval is 2010 - 2024

```{r echo=FALSE}
sacramento_tisdale <- "edi.1499.5"
```

#### trap

  - Database date range

```{r echo=FALSE}
trap_with_stream |>  
  filter(trap_location_id %in% c(55, 56, 57)) |>  # trap id for Sacramento/Knights landing 
  summarize(min_date = min(trap_visit_time_end, na.rm = TRUE),
            max_date = max(trap_visit_time_end, na.rm = TRUE))
```

  - EDI: 2010 - 2024
  
#### release

  - Database date range 

```{r echo=FALSE}
release_with_stream |> 
  filter(trap_location_id %in% c(55, 56, 57)) |> 
  summarize(min_date = min(date_released, na.rm = TRUE),
            max_date = max(date_released, na.rm = TRUE))
```

  - EDI: 2012 - 2024
  
#### recapture

  - Database date range

```{r echo=FALSE}
recapture_with_stream |> 
  filter(trap_location_id %in% c(55, 56, 57)) |>
  summarize(min_date = min(date), max_date = max(date))
```

  - EDI: 2010 - 2024 
  