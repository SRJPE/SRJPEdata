
```{r include=FALSE}
library(DBI)
library(tidyverse)
library(EDIutils)
library(EML)
```

The purpose of this markdown is to compare the data that we have in jpe database and EDI 

```{r}
con <- DBI::dbConnect(drv = RPostgres::Postgres(),
                      host = "jpe-db.postgres.database.azure.com",
                      dbname = "jpedb-prod",
                      user = Sys.getenv("jpe_db_user_id"),
                      password = Sys.getenv("jpe_db_password"),
                      port = 5432)

DBI::dbListTables(con)
# tables to look at:
# catch, trap, release and recapture_fish (check if it is release or release_fish) 
```

# catch table

```{r include=FALSE}
catch <- DBI::dbReadTable(con, "catch")
```

```{r echo=FALSE}
head(catch)

colnames(catch)
```
streams in catch table

```{r}
unique(catch$trap_location_id)

catch |> 
  mutate(i)
  left_join(trap_location, by = ("trap_location_id" = "id")) |> 
  view()
```

date range
```{r echo=FALSE}
range(catch$date, na.rm = TRUE)
```

# trap table

```{r include=FALSE}
trap <- DBI::dbReadTable(con, "trap_visit")
```

```{r echo=FALSE}
head(trap)

colnames(trap)
```

date range

  - `trap_visit_start`
```{r echo=FALSE}
range(trap$trap_visit_time_start, na.rm = TRUE)
```

  - `trap_visit_end`
  
```{r echo=FALSE}
range(trap$trap_visit_time_end, na.rm = TRUE)
```

# release table

```{r include=FALSE}
release <- DBI::dbReadTable(con, "release")
```

```{r echo=FALSE}
head(release)

colnames(released)
```

date range
```{r echo=FALSE}
range(release$date_released, na.rm = TRUE)
```

# recaptured_fish table

```{r include=FALSE}
recaptured_fish <- DBI::dbReadTable(con, "recaptured_fish")
```

```{r echo=FALSE}
head(recaptured_fish)

colnames(recaptured_fish)
```

date range
```{r echo=FALSE}
range(recaptured_fish$date, na.rm = TRUE)
```

Exploration per stream


# Battle/Clear Creek

## catch

  - Database date range
  
```{r echo=FALSE}
# pulling trap table to tie to a steam
trap_location <- DBI::dbReadTable(con, "trap_location")
trap_id <- trap_location |> 
  rename(trap_location_id = id) |>
  select(trap_location_id, stream) |>  glimpse()

catch_with_stream <- catch |>
  left_join(trap_id)
  
catch_with_stream |> 
  filter(stream %in% c("clear creek", "battle creek")) |> 
  summarize(min_date = min(date), max_date = max(date))
  
```
  
  - EDI date range

```{r echo=FALSE}
# creating a function since will use for multiple streams
get_date_range <- function(package_id) {
  eml_text <- read_metadata(packageId = package_id)
  eml <- read_eml(eml_text)
  range <- eml$dataset$coverage$temporalCoverage$rangeOfDates
  c(begin = range$beginDate$calendarDate, end = range$endDate$calendarDate)
}

get_date_range("edi.1509.3") # Battle/Clear edi
```

# Butte

## catch

  - Database date range
  
```{r echo=FALSE}
catch_with_stream |> 
  filter(stream == "butte creek") |> 
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))

```
  
 - EDI date range

```{r echo=FALSE}
butte <- "edi.1497.18"

get_date_range(butte)
```

# Feather River

## catch

  - Database date range
  
```{r echo=FALSE}
catch_with_stream |> 
  filter(stream == "feather river") |> 
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))

```
  
 - EDI date range

```{r echo=FALSE}
feather <- "edi.1239.23"

get_date_range(feather)
```


# Yuba

## catch

  - Database date range
  
```{r echo=FALSE}
catch_with_stream |> 
  filter(stream == "yuba river") |> 
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))

```
  
 - EDI date range

```{r echo=FALSE}
yuba <- "edi.1529.24"


get_date_range(yuba)
```

# Sacramento/Knights landing 

## catch

  - Database date range

```{r}
catch_with_stream |> 
  filter(trap_location_id %in% c(51, 52, 53, 54)) |>  # trap id for Sacramento/Knights landing
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))
```
  - EDI date range
  
  
```{r echo=FALSE}

sacramento <- "edi.1501.9"
get_date_range(sacramento)

```

# Sacramento/Tisdale

## catch

  - Database date range

```{r}
catch_with_stream |> 
  filter(trap_location_id %in% c(55,56,57)) |>  # trap id for Sacramento/Knights landing
  summarize(min_date = min(date, na.rm = TRUE), max_date = max(date, na.rm = TRUE))
```
  - EDI date range
  
  
```{r echo=FALSE}
sacramento_tisdale <- "edi.1499.5"
get_date_range(sacramento_tisdale)
```

