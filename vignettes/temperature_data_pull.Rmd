---
title: "Combine Temperature Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Yearling Ruleset}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)

library(tidyverse)
library(googleCloudStorageR)
library(CDECRetrieve)
library(lubridate)
library(hms)
library(dataRetrieval)
library(SRJPEdata)
source(here::here("data-raw", "pull_tables_from_database.R"))
```

FlowWest aggregated environmental data for temperature data from all 
monitoring programs:

-   Battle Creek (source: FWS gage data (xlsx version))
-   Butte Creek (source: CDEC)
-   Clear Creek (source: FWS gage data (xlsx version))
-   Deer Creek (source: CDEC)
-   Feather River (source: RST monitoring data)
-   Mill Creek (source: CDEC)
-   Sacramento River (source for Tisdale: USGS; source for Knights
    Landing: RST monitoring data)
-   Yuba River (source: RST monitoring data)

### Rational for Data Sources:

The following decision hierarchy was used to determine which datasets
were used in the final temperature data aggregation:

1.  Is there publicly available data available through USGS or CDEC?
    This data can easily be built into a data pipeline because it's
    available through a query and publicly available. The data is also
    QC'd and available at precise temporal scales like hourly.
2.  If no, is there data available through gages operated by Fish and Wildlife?
3.  If no, is there RST temperature monitoring data available?
4.  If no, perform linear regression on air temperature to get modeled
    stream temperature for site

## Standard format for Temperature Data

Data dictionary for standard format:

(B - Battle Creek, Bu - Butte Creek, C - Clear Creek, F - Feather River,
D - Deer Creek, F - Feather River, M - Mill Creek, S- Sacramento River,
Y - Yuba River)

| column name       | stream collects   | definition                                          |
|:-----------------|:-------------------|:---------------------------------|
| date              | B, Bu, C, D, M, F | date that measurement occurs                        |
| stream            | B, Bu, C, D, M, F | unique stream name associated with temperature data |
| site              | B, Bu, C, D, M, F | unique site identifier where measurement occurs     |
| source            | B, Bu, C, D, M, F | data source                                         |
| location          | F                 | differentiates between `high flow` and `low flow`   |
| mean_daily_temp_c | B, Bu, C, D, M, F | average daily temperature (degrees Celsius)         |
| max_daily_temp_c  | B, C              | maximum daily temperature (degrees Celsius)         |

# Pull in data and format {.tabset}

Initial data exploration was done within [JPE datasets](https://github.com/SRJPE/JPE-datasets/blob/main/data-raw/qc-markdowns/temperature_data_prep.Rmd)

### All RST Environmental Data 

```{r, include = F}
# gcs_auth(json_file = Sys.getenv("GCS_AUTH_FILE"))
# gcs_global_bucket(bucket = Sys.getenv("GCS_DEFAULT_BUCKET"))
```

## Battle Creek

-   One site from the Fish and Wildlife Service provides data from
    `2003-01-07` to `2021-02-2021`. Pull from EXCEL. 

***THINK ABOUT HOW WE WANT TO UPDATE THESE DATA? NEED TO GET NEW DATA FROM BATTLE CLEAR CREW*** 
```{r}
# get data from google cloud
# TODO update once battle and clear are in database
# gcs_get_object(object_name = "environmental/data-raw/battle_clear_RSTTEMPS_07052022.xlsx",
#                bucket = gcs_get_global_bucket(),
#                saveToDisk =  here::here("data-raw", "temperature-data", "battle_clear_temp.xlsx"),
#                overwrite = TRUE)

ubc_temp_raw <- readxl::read_excel(here::here("data-raw", 
                                              "temperature-data", 
                                              "battle_clear_temp.xlsx"), sheet = 4)

battle_format <- ubc_temp_raw %>% 
  rename(date = DT,
         temp_c = TEMP_C) %>%
  mutate(stream = "battle creek", 
         site = "ubc",
         subsite = "ubc",
         date = as.Date(date),
         source = "FWS") %>%
  group_by(date, stream, site, source, subsite) %>%
  summarise(mean_temp_degC = mean(temp_c, na.rm = T),
            max_temp_degC = max(temp_c, na.rm = T)) %>% 
  filter(mean_temp_degC > 0) %>%
  glimpse

summary(battle_format)

battle_format %>% ggplot() + 
  geom_line(aes(x = date, y = mean_temp_degC, color = site)) + 
  # geom_point(aes(x = date, y = mean_temp_degC), size = .001) +
  theme_minimal()

# filter(catch, stream == "battle creek") |> distinct(site, subsite)
```

## Butte Creek

-   The CDEC gage `BCK` was used to aggregate temperature for sites
    `adams dam` and `okie dam` from `1998-09-16` to `2022-06-30`.

```{r}
# source CDEC
# TODO add data checks for temp data pulls 
BCK_CDEC <- cdec_query(station = "BCK", 
                       dur_code = "H", 
                       sensor_num = "25", 
                       start_date = "1995-01-01")
# make hourly 
BCK_hourly_temps <- BCK_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degC = SRJPEdata::fahrenheit_to_celsius(parameter_value)) %>%
  select(date, time, temp_degC)

BCK_daily_temps <- BCK_hourly_temps %>% 
  group_by(date) %>% 
  summarize(mean_temp_degC = mean(temp_degC, na.rm = T),
            max_temp_degC = max(temp_degC, na.rm = T)) 

# FORMAT
butte_format <- BCK_daily_temps %>%
  mutate(stream = "butte creek",
         source = "CDEC BCK")

butte_sites <- filter(catch, stream == "butte creek") |> 
  select(stream, site, subsite) |> 
  distinct()

butte_format_all <- full_join(butte_format, butte_sites)

summary(butte_format_all$date)

butte_format_all %>% ggplot() + 
  geom_line(aes(x = date, y = mean_temp_degC, color = site)) + 
  # geom_point(aes(x = date, y = mean_temp_degC), size = .001) +
  theme_minimal() 

filter(catch, stream == "butte creek") |> distinct(site, subsite)
```

## Clear Creek

-   Clear Creek data was aggregated from Fish Wildlife Service's site
    `lcc` from `2001-02-16` to `2021-12-31`

```{r}
ucc_temp_raw <- readxl::read_excel(here::here("data-raw",
                                              "temperature-data", 
                                              "battle_clear_temp.xlsx"), sheet = 2)

ucc_temp <- ucc_temp_raw %>% 
  rename(date = DT,
         temp_c = TEMP_C) %>%
  mutate(stream = "clear creek", 
         site = "ucc",
         subsite = "ucc",
         date = as.Date(date)) %>%
  glimpse

lcc_temp_raw <- readxl::read_excel(here::here("data-raw",
                                              "temperature-data", 
                                              "battle_clear_temp.xlsx"), sheet = 3)
lcc_temp <- lcc_temp_raw %>% 
  rename(date = DT,
         temp_c = TEMP_C) %>% 
  mutate(stream = "clear creek", 
         site = "lcc",
         subsite = "lcc",
         date = as.Date(date)) %>%
  glimpse

clear_format <- bind_rows(lcc_temp, ucc_temp) %>% 
  group_by(date, stream, site, subsite) %>%
  summarise(mean_temp_degC = mean(temp_c, na.rm = T),
            max_temp_degC = max(temp_c, na.rm = T)) %>% 
  mutate(source = "FWS") %>% glimpse

summary(clear_format$date)

clear_format %>% ggplot() + 
  geom_line(aes(x = date, y = mean_temp_degC, color = site)) + 
  # geom_point(aes(x = date, y = mean_temp_degC), size = .001) +
  theme_minimal()

filter(catch, stream == "clear creek") |> distinct(site, subsite)
```

## Deer Creek

-   Deer Creek data was aggregated from CDEC's site `DCV` from
    `1998-10-01` to `2022-07-13`

```{r}
# source 
# PUll data from CDEC - DCV (Deer Creek Near Vina)
DCV_CDEC <- cdec_query(station = "DCV", 
                       dur_code = "H", 
                       sensor_num = "25", 
                       start_date = "1995-01-01")

DCV_hourly_temps <- DCV_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degC = SRJPEdata::fahrenheit_to_celsius(parameter_value, round = 1)) %>%
  select(date,time,temp_degC)

# Daily summary 
DCV_daily_temps <- DCV_hourly_temps %>% 
  filter(!is.na(temp_degC)) %>%
  group_by(date) %>% 
  summarize(mean_temp_degC = mean(temp_degC, na.rm = T),
            max_temp_degC = max(temp_degC, na.rm = T)) 

deer_format <- DCV_daily_temps %>%
  mutate(stream = "deer creek",
         site = stream,
         subsite = site,
         source = "CDEC DCV") %>%
  filter(mean_temp_degC > 0 & mean_temp_degC < 35,
         max_temp_degC > 0 & max_temp_degC < 35) %>% 
  glimpse()

summary(deer_format$date)

deer_format %>% ggplot() + 
  geom_line(aes(x = date, y = mean_temp_degC), color = "gray") + 
  theme_minimal()

deer_format %>% ggplot() + 
  geom_line(aes(x = date, y = max_temp_degC), color = "gray") + 
  theme_minimal()
```

## Feather River

-   Chose to use RST environmental data instead of CDEC or USGS because
    a significant data gap exists in publicly available data between
    2006-09-05 and 2018-09-30. The two publicly available sites are also
    spatially far apart.

-   Feather River data can be aggregate by high and low flows using the
    `location` column


```{r}
# TODO feather flow is not in the database, need to add! currently all NA 
feather_rst <- trap %>% 
  filter(stream == "feather river") %>% 
  select(stream, site, subsite, date = trap_start_date, water_temp) %>%
  rename(mean_temp_degC = water_temp) %>%
  mutate(source = "RST environmental") %>% 
  filter(mean_temp_degC > 0) %>%
  glimpse()

ggplot() +
  geom_line(data = feather_rst, aes(x = date, y = mean_temp_degC, color = subsite)) + 
  facet_wrap(~site) +
  theme_minimal()
```

## Mill Creek

-   Mill Creek temperature data is sourced from CDEC's site `MLM` from
    `1998-10-07` to `2022-07-13`

```{r}
# cdec_datasets("MLM") 

MLM_CDEC <- cdec_query(station = "MLM", dur_code = "H", sensor_num = "25", start_date = "1996-01-01")

MLM_hourly_temps <- MLM_CDEC %>%
  mutate(date = as_date(datetime),
         time = as_hms(datetime),
         temp_degC = SRJPEdata::fahrenheit.to.celsius(parameter_value, round = 1)) %>%
  select(date,time,temp_degC)

MLM_daily_temps <- MLM_hourly_temps %>% 
  group_by(date) %>% 
  summarize(mean_temp_degC = mean(temp_degC),
            max_temp_degC = max(temp_degC)) 

# source 
mill_format <- MLM_daily_temps %>%
  mutate(stream = "mill creek",
         site = stream, 
         subsite = site,
         source = "CDEC MLM") %>%
   filter(mean_temp_degC > 0 & mean_temp_degC < 35,
          max_temp_degC > 0 & max_temp_degC < 35) %>% 
glimpse()

summary(mill_format$date)

mill_format %>% ggplot() + 
  geom_line(aes(x = date, y = mean_temp_degC), color = "gray") + 
  # geom_point(aes(x = date, y = mean_temp_degC), size = .001) +
  theme_minimal()
```

## Sacramento

-   combined dataset spans `1998-10-01` to `2022-07-25` and includes RST
    environmental data from Knights Landing and USGS data from Tisdale

#### Gage Data

-   Data is from `USGS 11390500` and exists from `1989-10-01` to
    `2022-07-25` with a significant data gap between `1998-09-30` and
    `2016-10-01`
  - use for both Knights Landing and Tisdale

```{r}

### USGS 11390500
# Read created CSV
WLK_USGS <- readNWISdv(11390500, "00010")

# Format to make tidier
sac_usgs_format <- WLK_USGS %>%
  select(Date, temp_degC =  X_00010_00003) %>%
  as_tibble() %>% 
  rename(date = Date,
         mean_temp_degC = temp_degC) %>% 
  mutate(stream = "sacramento river", 
         source = "USGS 11390500") %>%
  #filter(year(date) > 2000) %>% # filter to greater than 2000
  glimpse

# Plot
ggplot() +
  geom_line(data = sac_usgs_format, aes(x = date, y = mean_temp_degC), color = "black") +
  labs(x = "date",
       y = "Temperature (deg C)", 
       caption = "USGS 11390500")
```

#### Sacramento RST Environmental Data 

-   One site: `knights landing`; apply to Tisdale

-   Date range from `2002-10-04` to `2021-05-31` with a two year gap
    between `2016-06-20` and `2018-08-28`

```{r}

sac_rst_format <- trap %>% 
  filter(stream == "sacramento river") %>% 
  select(stream, date = trap_stop_date, value = water_temp) %>%
  rename(mean_temp_degC = value) %>%
  mutate(source = "RST environmental") %>%
  glimpse

summary(sac_rst_format$date)

ggplot() +
  geom_line(data = sac_rst_format, aes(x = date, y = mean_temp_degC))

```

#### Combine Sacramento data

-   combined dataset spans `1998-10-01` to `2022-07-25` and includes RST
    environmental data from Knights Landing and USGS data from Tisdale

```{r}

sac_format <- bind_rows(sac_rst_format, # rst
                        sac_usgs_format) %>% 
  group_by(stream, date, mean_temp_degC, source) |> 
  distinct()
# need to apply values for all sacramento sites and subsites
sac_sites <- filter(catch, stream == "sacramento river") |> 
  select(stream, site, subsite) |> 
  distinct()

sac_format_all <- full_join(sac_format, sac_sites)

summary(sac_format_all$date)

ggplot() +
  geom_line(data = sac_format_all, aes(x = date, y = mean_temp_degC, color = site)) 
  #facet_wrap(~site)

```

## Yuba

- There is limited USGS data and CDEC gage is far from the RST
- Current approach is to use Yuba RST temperature data
- Another possible option to model using air temperature

```{r}
#TODO need to do air temp modeling, check temperature_data_prep for potential gages (if not there use noaa data)

yuba_rst_format <- trap %>% 
  filter(stream == "yuba river") %>% 
  select(stream, site, subsite, date = trap_stop_date, value = water_temp) %>%
  rename(mean_temp_degC = value) %>%
  mutate(source = "RST environmental") %>%
  glimpse

summary(yuba_rst_format$date)

ggplot() +
  geom_line(data = yuba_rst_format, aes(x = date, y = mean_temp_degC))
```


```{r}
# limited USGS gage data 
# USGS 11417500 S YUBA R A JONES BAR NR GRASS VALLEY CA
# site_no=11417500

#cdec_datasets('YRS')
cdec_yrs <- cdec_query(station = "YRS", dur_code = "H", sensor_num = "25", start_date = "1996-01-01") 

## TODO: convert to C from F
cdec_yrs_format <- cdec_yrs %>% 
  rename(source = agency_cd,
         site = location_id, 
         temperature_c = parameter_value,
         date = datetime) %>%
  mutate(date = as_date(date),
         temperature_c = (temperature_c-32 * 5/9)) %>%
  group_by(date) %>%
  mutate(mean_temp_degC = mean(temperature_c, na.rm = TRUE),
         max_temp_degC = max(temperature_c, na.rm = TRUE)) %>%
  filter(mean_temp_degC > 0) %>%
  glimpse
  
summary(cdec_yrs_format)


ggplot() +
  geom_line(data = cdec_yrs_format, aes(x = date, y = mean_temp_degC))
```



# Combine temperature data {.tabset}

```{r}
combined_temp <- bind_rows(battle_format,
                           butte_format_all,
                           clear_format,
                           deer_format,
                           feather_rst,
                           mill_format,
                           sac_format_all,
                           #yuba_format,
                           yuba_rst_format
                           ) %>%
  rename(mean_daily_temp_c  = mean_temp_degC,
         max_daily_temp_c = max_temp_degC) %>%
  glimpse()
```

## QA/QC

```{r}
summary(combined_temp)
unique(combined_temp$stream)
unique(combined_temp$site)
unique(combined_temp$subsite)
ggplot(combined_temp, aes(x = date, y = mean_daily_temp_c, color = site)) +
  theme_minimal() +
  geom_line() +
  facet_wrap(~stream)
filter(combined_temp, is.na(date)) 
filter(combined_temp, mean_daily_temp_c == "NaN") 
filter(combined_temp, max_daily_temp_c == "-Inf") 
filter(combined_temp, is.na(max_daily_temp_c)) %>% pull(stream) %>% unique
combined_temp_clean <- filter(combined_temp, !is.na(date)) %>% 
  mutate(mean_daily_temp_c = ifelse(is.nan(mean_daily_temp_c), NA, mean_daily_temp_c),
         max_daily_temp_c = ifelse(max_daily_temp_c == "-Inf", NA, max_daily_temp_c)) %>% glimpse

summary(combined_temp_clean)

filter(combined_temp_clean, mean_daily_temp_c == "NaN") 
filter(combined_temp_clean, max_daily_temp_c == "-Inf") 
unique(combined_temp_clean$stream)
unique(combined_temp_clean$source)
```

```{r, include = FALSE, eval = FALSE}
f <- function(input, output) write_csv(input, file = output)

gcs_upload(combined_temp_clean,
           object_function = f,
           type = "csv",
           name = "standard-format-data/standard_temperature.csv",
           predefinedAcl = "bucketLevel")
write_csv(combined_temp_clean, "data/standard-format-data/standard_temperature.csv")
```