select(-run) |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count, 0, expanded_weekly_hatch_count))) |>
glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
select(-run) |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count)) |>
glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
select(-run) |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
count_natural = count - expanded_weekly_hatch_count,
count_hatchery = expanded_weekly_hatch_count) |>
glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
select(-run) |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
count_natural = count - expanded_weekly_hatch_count,
count_hatchery = expanded_weekly_hatch_count) |>
View()
hatch_per_week |> filter(site_week_year == "tisdale_2018_4")
hatch_per_week |> filter(site_year_week == "tisdale_2018_4")
hatch_per_week |> filter(site == "tisdale", year == 2018, week == 4)
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- weekly_standard_catch |>
filter(adipose_clipped == TRUE) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarise(weekly_hatchery_count_per_lifestage = sum(count, na.rm = TRUE),
expanded_weekly_hatch_count = ifelse(stream == "feather river",
weekly_hatchery_count_per_lifestage,
weekly_hatchery_count_per_lifestage * 4)) |> #ASSUMING 25% marking, add mark rates in here instead.
# select(-weekly_hatchery_count_per_lifestage) |>
glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
select(-run) |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
count_natural = count - expanded_weekly_hatch_count,
count_hatchery = expanded_weekly_hatch_count) |>
View()
# summarize by week -----------------------------------------------------------
# Removed lifestage and yearling for now - can add back in but do not need for btspasx model input so removing
# TODO review logic with Ashley/Liz to confirm
# TODO confirm that okay to remove Run designation here! (causes many to many join problems with hatch fish), seems okay to remove since we are later using PLAD to designate
weekly_standard_catch_no_zeros <- catch_with_inclusion_criteria |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) %>% #removed run & adclip here
summarize(mean_fork_length = mean(fork_length, na.rm = T),
mean_weight = mean(weight, na.rm = T),
count = sum(count, na.rm = T))  |>
filter(count > 0) |>
mutate(site_year_week = paste0(site, "_", year, "_", week)) |>
ungroup() |> glimpse()
catch_site_year_weeks <- unique(weekly_standard_catch_no_zeros$site_year_week)
weekly_standard_catch_zeros <- catch_with_inclusion_criteria |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) %>% #removed run & adclip here
summarize(mean_fork_length = mean(fork_length, na.rm = T),
mean_weight = mean(weight, na.rm = T),
count = sum(count, na.rm = T))  |>
filter(count == 0) |>
mutate(site_year_week = paste0(site, "_", year, "_", week)) |>
filter(!site_year_week %in% catch_site_year_weeks) |>
glimpse()
weekly_standard_catch <- bind_rows(weekly_standard_catch_no_zeros,
weekly_standard_catch_zeros) |> glimpse()
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- catch_with_inclusion_criteria |>
filter(adipose_clipped == TRUE) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarise(weekly_hatchery_count_per_lifestage = sum(count, na.rm = TRUE),
expanded_weekly_hatch_count = ifelse(stream == "feather river",
weekly_hatchery_count_per_lifestage,
weekly_hatchery_count_per_lifestage * 4)) |> #ASSUMING 25% marking, add mark rates in here instead.
# select(-weekly_hatchery_count_per_lifestage) |>
glimpse()
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- catch_with_inclusion_criteria |>
filter(adipose_clipped == TRUE) |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarise(weekly_hatchery_count_per_lifestage = sum(count, na.rm = TRUE),
expanded_weekly_hatch_count = ifelse(stream == "feather river",
weekly_hatchery_count_per_lifestage,
weekly_hatchery_count_per_lifestage * 4)) |> #ASSUMING 25% marking, add mark rates in here instead.
# select(-weekly_hatchery_count_per_lifestage) |>
glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
select(-run) |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
count_natural = count - expanded_weekly_hatch_count,
count_hatchery = expanded_weekly_hatch_count) |>
View()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
count_natural = count - expanded_weekly_hatch_count,
count_hatchery = expanded_weekly_hatch_count) |>
View()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
count_natural = count - expanded_weekly_hatch_count,
count_hatchery = expanded_weekly_hatch_count) |>
glimpse()
hatch_per_week
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- weekly_standard_catch |>
filter(adipose_clipped == TRUE) |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarise(weekly_hatchery_count_per_lifestage = sum(count, na.rm = TRUE),
expanded_weekly_hatch_count = ifelse(stream == "feather river",
weekly_hatchery_count_per_lifestage,
weekly_hatchery_count_per_lifestage * 4)) |> #ASSUMING 25% marking, add mark rates in here instead.
# select(-weekly_hatchery_count_per_lifestage) |>
glimpse()
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- catch_with_inclusion_criteria |>
filter(adipose_clipped == TRUE) |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarise(weekly_hatchery_count_per_lifestage = sum(count, na.rm = TRUE),
expanded_weekly_hatch_count = ifelse(stream == "feather river",
weekly_hatchery_count_per_lifestage,
weekly_hatchery_count_per_lifestage * 4)) |> #ASSUMING 25% marking, add mark rates in here instead.
glimpse()
catch_with_inclusion_criteria
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- catch_with_inclusion_criteria |>
filter(adipose_clipped == TRUE) |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarise(count = sum(count, na.rm = TRUE),
weekly_hatchery_count_per_lifestage = sum(count, na.rm = TRUE),
expanded_weekly_hatch_count = ifelse(stream == "feather river",
weekly_hatchery_count_per_lifestage,
weekly_hatchery_count_per_lifestage * 4)) |> #ASSUMING 25% marking, add mark rates in here instead.
glimpse()
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- catch_with_inclusion_criteria |>
filter(adipose_clipped == TRUE) |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarise(count = sum(count, na.rm = TRUE),
weekly_hatchery_count_per_lifestage = sum(count, na.rm = TRUE),
expanded_weekly_hatch_count = ifelse(stream == "feather river",
weekly_hatchery_count_per_lifestage,
weekly_hatchery_count_per_lifestage * 4)) |> #ASSUMING 25% marking, add mark rates in here instead.
ungroup()
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- catch_with_inclusion_criteria |>
filter(adipose_clipped == TRUE) |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarise(count = sum(count, na.rm = TRUE),
weekly_hatchery_count_per_lifestage = sum(count, na.rm = TRUE),
expanded_weekly_hatch_count = ifelse(stream == "feather river",
weekly_hatchery_count_per_lifestage,
weekly_hatchery_count_per_lifestage * 4)) |> #ASSUMING 25% marking, add mark rates in here instead.
ungroup() |>
glimpse()
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- catch_with_inclusion_criteria |>
filter(adipose_clipped == TRUE) |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) |>
reframe(count = sum(count, na.rm = TRUE),
weekly_hatchery_count_per_lifestage = sum(count, na.rm = TRUE),
expanded_weekly_hatch_count = ifelse(stream == "feather river",
weekly_hatchery_count_per_lifestage,
weekly_hatchery_count_per_lifestage * 4)) |> #ASSUMING 25% marking, add mark rates in here instead.
ungroup() |>
glimpse()
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- catch_with_inclusion_criteria |>
filter(adipose_clipped == TRUE) |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarize(count = sum(count, na.rm = TRUE)) |>
weekly_hatchery_count_per_lifestage = sum(count, na.rm = TRUE),
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- catch_with_inclusion_criteria |>
filter(adipose_clipped == TRUE) |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarize(count = sum(count, na.rm = TRUE)) |> glimpse()
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- catch_with_inclusion_criteria |>
filter(adipose_clipped == TRUE) |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarize(count = sum(count, na.rm = TRUE)) |>
ungroup() |>
mutate(expanded_weekly_hatch_count = ifelse(stream == "feather river",
count,
count * 4)) |> #ASSUMING 25% marking, add mark rates in here instead.
glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
count_natural = count - expanded_weekly_hatch_count,
count_hatchery = expanded_weekly_hatch_count) |>
glimpse()
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- catch_with_inclusion_criteria |>
filter(adipose_clipped == TRUE) |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarize(count = sum(count, na.rm = TRUE)) |>
ungroup() |>
mutate(expanded_weekly_hatch_count = ifelse(stream == "feather river",
count,
count * 4)) |> #ASSUMING 25% marking, add mark rates in here instead.
glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |> glimpse()
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- catch_with_inclusion_criteria |>
filter(adipose_clipped == TRUE) |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarize(count = sum(count, na.rm = TRUE)) |>
ungroup() |>
mutate(expanded_weekly_hatch_count = ifelse(stream == "feather river",
count,
count * 4)) |> #ASSUMING 25% marking, add mark rates in here instead.
select(-count) |>
glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |> glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
count_natural = count - expanded_weekly_hatch_count,
count_hatchery = expanded_weekly_hatch_count) |>
glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
count_natural = count - expanded_weekly_hatch_count,
count_hatchery = expanded_weekly_hatch_count) |>
View()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
natural = count - expanded_weekly_hatch_count,
hatchery = expanded_weekly_hatch_count) |>
pivot_longer(natural:hatchery, names_to = origin, values_to = count) |>
glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
natural = count - expanded_weekly_hatch_count,
hatchery = expanded_weekly_hatch_count) |>
pivot_longer(natural:hatchery, names_to = "origin", values_to = "count") |>
glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
natural = count - expanded_weekly_hatch_count,
hatchery = expanded_weekly_hatch_count) |>
select(-count) |>
pivot_longer(natural:hatchery, names_to = "origin", values_to = "count") |>
glimpse()
natural = ifelse(count - expanded_weekly_hatch_count < 0, 0, count - expanded_weekly_hatch_count),
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
natural = ifelse(count - expanded_weekly_hatch_count < 0, 0, count - expanded_weekly_hatch_count),
hatchery = ifelse(expanded_weekly_hatch_count > count, count, expanded_weekly_hatch_count)) |>
select(-count) |>
pivot_longer(natural:hatchery, names_to = "origin", values_to = "count") |>
glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
natural = ifelse(count - expanded_weekly_hatch_count < 0, 0, count - expanded_weekly_hatch_count),
hatchery = ifelse(expanded_weekly_hatch_count > count, count, expanded_weekly_hatch_count)) |>
select(-count) |>
pivot_longer(natural:hatchery, names_to = "origin", values_to = "count") |>
View()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
natural = ifelse(count - expanded_weekly_hatch_count < 0, 0, count - expanded_weekly_hatch_count),
hatchery = ifelse(expanded_weekly_hatch_count > count, count, expanded_weekly_hatch_count)) |>
select(-count) |>  View()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
natural = ifelse(count - expanded_weekly_hatch_count < 0, 0, count - expanded_weekly_hatch_count),
hatchery = ifelse(expanded_weekly_hatch_count > count, count, expanded_weekly_hatch_count)) |>
View()
catch |> filter(stream == "feather river") |> pull(site) |> unique()
pkgdown::build_site()
weekly_model_data
weekly_standard_catch <- bind_rows(weekly_standard_catch_no_zeros,
weekly_standard_catch_zeros) |> glimpse()
weekly_standard_catch
glimpse(weekly_catch_effort)
glimpse(weekly_standard_catch)
# TODO add hatchery column by expanding on adclip rate and adclip caught in the trap
# TODO need to figure out what happens with adipose_clipped = NA
hatch_per_week <- catch_with_inclusion_criteria |>
filter(adipose_clipped == TRUE) |>
mutate(week = week(date),
year = year(date)) |>
group_by(week, year, stream, site, site_group, life_stage) |>
summarize(count = sum(count, na.rm = TRUE)) |>
ungroup() |>
mutate(expanded_weekly_hatch_count = ifelse(stream == "feather river",
count,
count * 4)) |> #ASSUMING 25% marking, add mark rates in here instead.
select(-count) |>
glimpse()
hatch_per_week
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
natural = ifelse(count - expanded_weekly_hatch_count < 0, 0, count - expanded_weekly_hatch_count),
hatchery = ifelse(expanded_weekly_hatch_count > count, count, expanded_weekly_hatch_count)) |>
select(-count) |>
pivot_longer(natural:hatchery, names_to = "origin", values_to = "count") |>
glimpse()
View(weekly_standard_catch_with_hatch_designation)
1244/4
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
natural = ifelse(count - expanded_weekly_hatch_count < 0, 0, count - expanded_weekly_hatch_count),
hatchery = ifelse(expanded_weekly_hatch_count > count, count, expanded_weekly_hatch_count)) |>
select(-count, expanded_weekly_hatch_count) |>
pivot_longer(natural:hatchery, names_to = "origin", values_to = "count") |>
glimpse()
# subtract these values from weekly_standard_catch
weekly_standard_catch_with_hatch_designation <- weekly_standard_catch |>
left_join(hatch_per_week,
by = c("week", "year", "stream", "site", "site_group", "life_stage")) |>
mutate(expanded_weekly_hatch_count = ifelse(is.na(expanded_weekly_hatch_count), 0, expanded_weekly_hatch_count),
natural = ifelse(count - expanded_weekly_hatch_count < 0, 0, count - expanded_weekly_hatch_count),
hatchery = ifelse(expanded_weekly_hatch_count > count, count, expanded_weekly_hatch_count)) |>
select(-count, -expanded_weekly_hatch_count) |>
pivot_longer(natural:hatchery, names_to = "origin", values_to = "count") |>
glimpse()
weekly_model_data <- weekly_model_data |>
left_join(efficiency_standard_flows, by = c("year", "week", "stream", "site"))
weekly_model_data
glimpse(weekly_model_data  )
weekly_model_data
# Combine all 3 tables together
weekly_model_data <- catch_reformatted |>
left_join(weekly_effort_by_site, by = c("year", "week", "stream", "site")) |>
# Join efficnecy data to catch data
left_join(weekly_efficiency,
by = c("week" = "week_released",
"year" = "year_released", "stream",
"site")) |>
# join flow data to dataset
left_join(flow_reformatted, by = c("week", "year", "site", "stream")) |>
# select columns that josh uses
select(year, week, stream, site, count, mean_fork_length,
number_released, number_recaptured, effort = hours_fished,
flow_cfs, life_stage) |>
group_by(stream) |>
mutate(average_stream_effort = mean(effort, na.rm = TRUE),
standardized_flow = as.vector(scale(flow_cfs))) |> # standardizes and centers see ?scale
ungroup() |>
mutate(run_year = ifelse(week >= 45, year + 1, year),
catch_standardized_by_effort = ifelse(is.na(effort), count, round(count * average_stream_effort / effort, 0))) |>
glimpse()
weekly_model_data
# Add in standardized efficiency flows
mainstem_standardized_efficiency_flows <- weekly_model_data |>
filter(site %in% c("knights landing", "tisdale", "red bluff diversion dam"),
!is.na(flow_cfs),
!is.na(number_released),
!is.na(number_recaptured)) |>
group_by(stream) |>
mutate(standardized_efficiency_flow = (flow_cfs - mean(flow_cfs, na.rm = T)) /
sd(flow_cfs, na.rm = T)) |>
select(year, week, stream, site, standardized_efficiency_flow)
mainstem_standardized_efficiency_flows
tributary_standardized_efficiency_flows <- weekly_model_data |>
filter(!site %in% c("knights landing", "tisdale", "red bluff diversion dam"),
!is.na(flow_cfs),
!is.na(number_released),
!is.na(number_recaptured)) |>
group_by(stream) |>
mutate(standardized_efficiency_flow = (flow_cfs - mean(flow_cfs, na.rm = T)) /
sd(flow_cfs, na.rm = T)) |>
select(year, week, stream, site, standardized_efficiency_flow)
tributary_standardized_efficiency_flows
efficiency_standard_flows <- bind_rows(mainstem_standardized_efficiency_flows,
tributary_standardized_efficiency_flows) |>
distinct()
efficiency_standard_flows
weekly_model_data_final <- weekly_model_data |>
left_join(efficiency_standard_flows, by = c("year", "week", "stream", "site"))
weekly_model_data_final
# Combine all 3 tables together
weekly_model_data_wo_efficiency_flows <- catch_reformatted |>
left_join(weekly_effort_by_site, by = c("year", "week", "stream", "site")) |>
# Join efficnecy data to catch data
left_join(weekly_efficiency,
by = c("week" = "week_released",
"year" = "year_released", "stream",
"site")) |>
# join flow data to dataset
left_join(flow_reformatted, by = c("week", "year", "site", "stream")) |>
# select columns that josh uses
select(year, week, stream, site, count, mean_fork_length,
number_released, number_recaptured, effort = hours_fished,
flow_cfs, life_stage) |>
group_by(stream) |>
mutate(average_stream_effort = mean(effort, na.rm = TRUE),
standardized_flow = as.vector(scale(flow_cfs))) |> # standardizes and centers see ?scale
ungroup() |>
mutate(run_year = ifelse(week >= 45, year + 1, year),
catch_standardized_by_effort = ifelse(is.na(effort), count, round(count * average_stream_effort / effort, 0))) |>
glimpse()
# Add in standardized efficiency flows
mainstem_standardized_efficiency_flows <- weekly_model_data |>
filter(site %in% c("knights landing", "tisdale", "red bluff diversion dam"),
!is.na(flow_cfs),
!is.na(number_released),
!is.na(number_recaptured)) |>
group_by(stream) |>
mutate(standardized_efficiency_flow = (flow_cfs - mean(flow_cfs, na.rm = T)) /
sd(flow_cfs, na.rm = T)) |>
select(year, week, stream, site, standardized_efficiency_flow)
weekly_model_data <- weekly_model_data_wo_efficiency_flows |>
left_join(efficiency_standard_flows, by = c("year", "week", "stream", "site"))
weekly_model_data
# TODO data checks
# Why does battle start in 2007 - did we intentionally leave early years out of database
usethis::use_data(weekly_model_data, overwrite = TRUE)
